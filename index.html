<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance System - Ban Nong Kok School</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f9f4; /* Light green background */
        }
        .header {
            background-color: #10B981; /* Green header */
            color: white;
        }
        .btn-primary {
            background-color: #059669; /* Darker green */
            color: white;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #047857;
        }
        .table-header th {
            background-color: #D1FAE5; /* Light green for table headers */
            color: #065F46; /* Dark green text */
        }
        .status-present { background-color: #A7F3D0 !important; color: #047857; } /* Light Green */
        .status-sick { background-color: #FECACA !important; color: #B91C1C; }    /* Light Red */
        .status-leave { background-color: #FEF08A !important; color: #A16207; }   /* Light Yellow */
        .status-absent { background-color: #FFDDBA !important; color: #C2410C; }  /* Light Orange */

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #10B981;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            display: none; /* Hidden by default */
        }
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .toast.show {
            opacity: 1;
        }
        .toast.success { background-color: #10B981; }
        .toast.error { background-color: #EF4444; }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f0f9f4;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #10B981;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #059669;
        }
        /* Ensure select dropdown arrows are visible */
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="loader" class="loader"></div>
    <div id="toast" class="toast"></div>

    <header class="header p-4 shadow-md">
        <h1 class="text-2xl font-bold text-center">ระบบบันทึกการเข้าเรียน - โรงเรียนบ้านหนองกก</h1>
        <p class="text-sm text-center">สำหรับครูประจำชั้น: ครูติ๊ก (Kru Tiss)</p>
    </header>

    <main class="container mx-auto p-4 md:p-6">
        <section id="controls" class="mb-6 p-4 bg-white rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4 text-green-700">เลือกข้อมูล</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                    <label for="datePicker" class="block text-sm font-medium text-gray-700 mb-1">วันที่:</label>
                    <input type="date" id="datePicker" name="datePicker" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500">
                </div>
                <div>
                    <label for="semester" class="block text-sm font-medium text-gray-700 mb-1">ภาคเรียน:</label>
                    <select id="semester" name="semester" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500">
                        <option value="1">ภาคเรียนที่ 1</option>
                        <option value="2">ภาคเรียนที่ 2</option>
                    </select>
                </div>
                <div>
                    <label for="academicYear" class="block text-sm font-medium text-gray-700 mb-1">ปีการศึกษา:</label>
                    <select id="academicYear" name="academicYear" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500">
                        </select>
                </div>
                <div>
                    <label for="gradeLevel" class="block text-sm font-medium text-gray-700 mb-1">ระดับชั้น:</label>
                    <select id="gradeLevel" name="gradeLevel" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500">
                        <option value="P.4">ประถมศึกษาปีที่ 4 (P.4)</option>
                        <option value="P.5">ประถมศึกษาปีที่ 5 (P.5)</option>
                        <option value="P.6">ประถมศึกษาปีที่ 6 (P.6)</option>
                    </select>
                </div>
            </div>
            <button id="loadStudentsBtn" class="mt-4 btn-primary font-semibold py-2 px-4 rounded-md shadow-sm hover:shadow-md w-full md:w-auto">
                โหลดรายชื่อนักเรียน
            </button>
        </section>

        <section id="attendanceSection" class="mb-6 p-4 bg-white rounded-lg shadow hidden">
            <h2 class="text-xl font-semibold mb-4 text-green-700">บันทึกการเข้าเรียน</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 border border-gray-300">
                    <thead class="table-header">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">รูป</th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">เลขที่</th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">รหัสนักเรียน</th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">ชื่อ-นามสกุล</th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">สถานะ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">หมายเหตุ (ป่วย/ลา)</th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">เอกสารแนบ</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
            <button id="saveAttendanceBtn" class="mt-6 btn-primary font-semibold py-2 px-4 rounded-md shadow-sm hover:shadow-md w-full md:w-auto">
                บันทึกข้อมูลการเข้าเรียน
            </button>
        </section>

        <section id="dailySummarySection" class="mb-6 p-4 bg-white rounded-lg shadow hidden">
            <h2 class="text-xl font-semibold mb-4 text-green-700">สรุปการเข้าเรียนรายวัน</h2>
            <div id="summaryContent" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                </div>
        </section>
        
        <section id="teacherNotesSection" class="mb-6 p-4 bg-white rounded-lg shadow hidden">
            <h2 class="text-xl font-semibold mb-4 text-green-700">บันทึกเพิ่มเติมจากครู</h2>
            <textarea id="teacherNotes" rows="4" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" placeholder="บันทึกพฤติกรรมนักเรียนหรือข้อสังเกตอื่นๆ..."></textarea>
        </section>

        <section id="historySection" class="mb-6 p-4 bg-white rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-2 text-green-700">ประวัติการบันทึก</h2>
            <div class="flex flex-wrap gap-4 mb-4 items-end">
                <div>
                    <label for="historyGradeFilter" class="block text-sm font-medium text-gray-700 mb-1">กรองตามระดับชั้น:</label>
                    <select id="historyGradeFilter" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500">
                        <option value="">ทั้งหมด</option>
                        <option value="P.1">P.1</option>
                        <option value="P.2">P.2</option>
                        <option value="P.3">P.3</option>
                        <option value="P.4">P.4</option>
                        <option value="P.5">P.5</option>
                        <option value="P.6">P.6</option>
                        <option value="M.1">M.1</option>
                        <option value="M.2">M.2</option>
                        <option value="M.3">M.3</option>
                    </select>
                </div>
                 <button id="loadHistoryBtn" class="btn-primary font-semibold py-2 px-4 rounded-md shadow-sm hover:shadow-md">
                    แสดงประวัติ
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 border border-gray-300">
                    <thead class="table-header">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">วันที่บันทึก</th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">วันที่เข้าเรียน</th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">ระดับชั้น</th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">ภาคเรียน</th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">ปีการศึกษา</th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">จำนวนนักเรียน</th>
                             <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">ดูรายละเอียด</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
            <div id="paginationControls" class="mt-4 flex justify-center items-center space-x-2">
                </div>
        </section>
        
        <section id="exportSection" class="p-4 bg-white rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4 text-green-700">ส่งออกข้อมูล</h2>
            <p class="text-sm text-gray-600 mb-2">
                คุณสามารถส่งออกข้อมูลการเข้าเรียนเป็นไฟล์ Excel หรือ PDF ได้
                (หมายเหตุ: การส่งออกเป็น PDF จะเป็นการพิมพ์มุมมองปัจจุบันของตารางสรุป)
            </p>
            <div class="flex flex-wrap gap-4">
                <button id="exportExcelBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm2-1a1 1 0 00-1 1v.5h14V5a1 1 0 00-1-1H4zM3 15a1 1 0 001 1h12a1 1 0 001-1v- аспектыH3v.5zm0-2.5h14V8H3v4.5z" clip-rule="evenodd" />
                        <path d="M6.5 10.5a.5.5 0 000-1H5V9h1.5a.5.5 0 000-1H5V7.5a.5.5 0 00-1 0V12a.5.5 0 00.5.5H6a.5.5 0 00.5-.5V11h.5a.5.5 0 000-1H6.5zm4.5-.5a.5.5 0 01.5-.5H12V9h-.5a.5.5 0 01-.5-.5V7.5a.5.5 0 00-1 0V12a.5.5 0 00.5.5h.5a.5.5 0 00.5-.5V10zM15 12a.5.5 0 00.5-.5V7.5a.5.5 0 00-1 0v4a.5.5 0 00.5.5z" />
                    </svg>
                    ส่งออกเป็น Excel
                </button>
                <button id="exportPdfBtn" class="bg-red-500 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm flex items-center gap-2">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm0 2h12v12H4V4zm4 2a.5.5 0 000 1h4a.5.5 0 000-1H8zm0 3a.5.5 0 000 1h4a.5.5 0 000-1H8zm0 3a.5.5 0 000 1h2a.5.5 0 000-1H8z" clip-rule="evenodd" />
                    </svg>
                    ส่งออกเป็น PDF (พิมพ์)
                </button>
            </div>
        </section>

    </main>

    <footer class="text-center p-4 mt-8 text-sm text-gray-600 border-t border-gray-200">
        &copy; <span id="currentYear"></span> Ban Nong Kok School, Krabi Primary Educational Service Area Office. Attendance System.
    </footer>

    <script>
        // --- CONFIGURATION ---
        const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbxIIdhLQKwjMwFpW-YislqRfjO_-gh5jQfIuz_DwvnLpOfoHlherbGow0LcDVLo-cXc/exec"; // Replace with your deployed Apps Script URL
        const SHEET_ID = "1rQ8tqFHWSX8n9MwnCo7hUQ0oG3VLpiJygSeVdOmzxr0"; // Your Google Sheet ID
        const FOLDER_ID = "1WGRl8BPk5_pIbA1n8np8gA3wNxIt7zEW"; // Your Google Drive Folder ID
        const HISTORY_ITEMS_PER_PAGE = 10;

        // --- DOM ELEMENTS ---
        const datePicker = document.getElementById('datePicker');
        const semesterSelect = document.getElementById('semester');
        const academicYearSelect = document.getElementById('academicYear');
        const gradeLevelSelect = document.getElementById('gradeLevel');
        const loadStudentsBtn = document.getElementById('loadStudentsBtn');
        const attendanceSection = document.getElementById('attendanceSection');
        const attendanceTableBody = document.getElementById('attendanceTableBody');
        const saveAttendanceBtn = document.getElementById('saveAttendanceBtn');
        const dailySummarySection = document.getElementById('dailySummarySection');
        const summaryContent = document.getElementById('summaryContent');
        const teacherNotesSection = document.getElementById('teacherNotesSection');
        const teacherNotesTextarea = document.getElementById('teacherNotes');
        const historySection = document.getElementById('historySection');
        const historyGradeFilter = document.getElementById('historyGradeFilter');
        const loadHistoryBtn = document.getElementById('loadHistoryBtn');
        const historyTableBody = document.getElementById('historyTableBody');
        const paginationControls = document.getElementById('paginationControls');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const loader = document.getElementById('loader');
        const toastElement = document.getElementById('toast');
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        // --- APP STATE ---
        let students = [];
        let attendanceData = {}; // studentId: { status: 'Present', notes: '', fileInfo: null, timestamp: '' }
        let currentHistoryPage = 1;
        let totalHistoryPages = 1;
        let allHistoryData = [];


        // --- UTILITY FUNCTIONS ---
        function showLoader() { loader.style.display = 'block'; }
        function hideLoader() { loader.style.display = 'none'; }

        function showToast(message, type = 'success') {
            toastElement.textContent = message;
            toastElement.className = `toast ${type} show`;
            setTimeout(() => {
                toastElement.className = 'toast';
            }, 3000);
        }

        // --- INITIALIZATION ---
        function initializeControls() {
            // Set date to today
            const today = new Date().toISOString().split('T')[0];
            datePicker.value = today;

            // Populate academic years
            const currentYear = new Date().getFullYear();
            for (let i = 0; i < 5; i++) {
                const year = currentYear - i;
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + 543; // Display in Buddhist Era
                academicYearSelect.appendChild(option);
            }
            academicYearSelect.value = currentYear;
        }

        // --- STUDENT & ATTENDANCE LOGIC ---
        async function loadStudents() {
            if (!datePicker.value) {
                showToast("กรุณาเลือกวันที่", "error");
                return;
            }
            showLoader();
            attendanceSection.classList.add('hidden');
            dailySummarySection.classList.add('hidden');
            teacherNotesSection.classList.add('hidden');
            attendanceTableBody.innerHTML = ''; // Clear previous students
            students = [];
            attendanceData = {};

            const payload = {
                action: 'getStudents',
                grade: gradeLevelSelect.value,
                sheetId: SHEET_ID
            };

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();

                if (result.success && result.data) {
                    students = result.data;
                    if (students.length === 0) {
                         showToast(`ไม่พบรายชื่อนักเรียนสำหรับระดับชั้น ${gradeLevelSelect.value}`, 'error');
                         attendanceSection.classList.add('hidden');
                    } else {
                        renderAttendanceTable();
                        attendanceSection.classList.remove('hidden');
                        teacherNotesSection.classList.remove('hidden');
                        showToast('โหลดรายชื่อนักเรียนสำเร็จ', 'success');
                    }
                } else {
                    showToast(result.message || 'เกิดข้อผิดพลาดในการโหลดรายชื่อนักเรียน', 'error');
                    console.error("Error loading students:", result.message);
                }
            } catch (error) {
                showToast('การเชื่อมต่อกับเซิร์ฟเวอร์ล้มเหลว (โหลดนักเรียน)', 'error');
                console.error('Fetch error (loadStudents):', error);
            } finally {
                hideLoader();
            }
        }

        function renderAttendanceTable() {
            attendanceTableBody.innerHTML = ''; // Clear existing rows
            students.forEach(student => {
                const studentId = student.studentId || `id_${Date.now()}_${Math.random()}`; // Ensure an ID
                attendanceData[studentId] = { status: 'Present', notes: '', fileInfo: null, timestamp: '' }; // Default to Present

                const row = document.createElement('tr');
                row.id = `student-row-${studentId}`;
                row.classList.add('status-present'); // Default row color

                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap">
                        <img src="${student.photoUrl || 'https://placehold.co/40x40/10B981/FFFFFF?text=N/A'}" alt="Photo" class="h-10 w-10 rounded-full object-cover" onerror="this.src='https://placehold.co/40x40/10B981/FFFFFF?text=N/A'">
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${student.studentNumber || 'N/A'}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${student.studentId || 'N/A'}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${student.fullName || 'N/A'}</td>
                    <td class="px-4 py-2 whitespace-nowrap">
                        <select data-student-id="${studentId}" class="status-select w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500">
                            <option value="Present" selected>มาเรียน (Present)</option>
                            <option value="Sick">ป่วย (Sick)</option>
                            <option value="Leave">ลา (Leave)</option>
                            <option value="Absent">ขาด (Absent)</option>
                        </select>
                    </td>
                    <td class="px-4 py-2">
                        <input type="text" data-student-id="${studentId}" class="notes-input w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" placeholder="เหตุผล (ถ้ามี)">
                    </td>
                    <td class="px-4 py-2">
                        <input type="file" data-student-id="${studentId}" class="file-input block w-full text-sm text-slate-500
                          file:mr-4 file:py-2 file:px-4
                          file:rounded-full file:border-0
                          file:text-sm file:font-semibold
                          file:bg-green-50 file:text-green-700
                          hover:file:bg-green-100" accept=".pdf,.jpg,.jpeg,.png">
                        <span class="file-name-display text-xs text-gray-500 block mt-1"></span>
                    </td>
                `;
                attendanceTableBody.appendChild(row);
            });

            // Add event listeners for status changes, notes, and files
            document.querySelectorAll('.status-select').forEach(select => {
                select.addEventListener('change', handleStatusChange);
            });
            document.querySelectorAll('.notes-input').forEach(input => {
                input.addEventListener('input', handleNotesChange);
            });
            document.querySelectorAll('.file-input').forEach(input => {
                input.addEventListener('change', handleFileChange);
            });
        }

        function handleStatusChange(event) {
            const studentId = event.target.dataset.studentId;
            const newStatus = event.target.value;
            attendanceData[studentId].status = newStatus;
            
            const row = document.getElementById(`student-row-${studentId}`);
            row.className = ''; // Clear existing status classes
            switch (newStatus) {
                case 'Present': row.classList.add('status-present'); break;
                case 'Sick': row.classList.add('status-sick'); break;
                case 'Leave': row.classList.add('status-leave'); break;
                case 'Absent': row.classList.add('status-absent'); break;
            }
        }

        function handleNotesChange(event) {
            const studentId = event.target.dataset.studentId;
            attendanceData[studentId].notes = event.target.value;
        }

        async function handleFileChange(event) {
            const studentId = event.target.dataset.studentId;
            const file = event.target.files[0];
            const fileNameDisplay = event.target.nextElementSibling; // The span for file name

            if (file) {
                showLoader();
                fileNameDisplay.textContent = `กำลังอัปโหลด: ${file.name}`;
                try {
                    const base64String = await convertFileToBase64(file);
                    attendanceData[studentId].fileInfo = {
                        fileName: file.name,
                        mimeType: file.type,
                        base64Data: base64String
                    };
                    fileNameDisplay.textContent = `เลือกไฟล์: ${file.name}`;
                    showToast(`ไฟล์ ${file.name} พร้อมสำหรับการบันทึก`, 'success');
                } catch (error) {
                    console.error("Error converting file to base64:", error);
                    showToast('เกิดข้อผิดพลาดในการประมวลผลไฟล์', 'error');
                    fileNameDisplay.textContent = 'การประมวลผลไฟล์ล้มเหลว';
                    event.target.value = null; // Reset file input
                } finally {
                    hideLoader();
                }
            } else {
                attendanceData[studentId].fileInfo = null;
                fileNameDisplay.textContent = '';
            }
        }

        function convertFileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]); // Get only base64 part
                reader.onerror = error => reject(error);
            });
        }

        async function saveAttendance() {
            if (students.length === 0) {
                showToast("ไม่มีข้อมูลนักเรียนให้บันทึก", "error");
                return;
            }
            showLoader();

            const recordsToSave = [];
            const timestamp = new Date().toISOString();

            for (const student of students) {
                 const studentId = student.studentId; // Assuming studentId is reliably present from fetched data
                 if (attendanceData[studentId]) {
                    recordsToSave.push({
                        studentId: student.studentId,
                        studentNumber: student.studentNumber,
                        fullName: student.fullName,
                        status: attendanceData[studentId].status,
                        notes: attendanceData[studentId].notes,
                        fileInfo: attendanceData[studentId].fileInfo, // This will be null or {fileName, mimeType, base64Data}
                        timestamp: timestamp
                    });
                 }
            }
            
            const payload = {
                action: 'saveAttendance',
                sheetId: SHEET_ID,
                folderId: FOLDER_ID,
                date: datePicker.value,
                semester: semesterSelect.value,
                academicYear: academicYearSelect.value,
                grade: gradeLevelSelect.value,
                teacherNotes: teacherNotesTextarea.value,
                records: recordsToSave
            };
            
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    body: JSON.stringify(payload), // Send as JSON
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();

                if (result.success) {
                    showToast('บันทึกข้อมูลการเข้าเรียนสำเร็จ!', 'success');
                    updateDailySummary(recordsToSave);
                    dailySummarySection.classList.remove('hidden');
                    // Optionally, clear inputs or reset states
                    // loadStudents(); // Reload to reflect any server-side changes or clear inputs
                    loadAttendanceHistory(); // Refresh history
                } else {
                    showToast(result.message || 'เกิดข้อผิดพลาดในการบันทึกข้อมูล', 'error');
                    console.error("Error saving attendance:", result.message, result.error);
                }
            } catch (error) {
                showToast('การเชื่อมต่อกับเซิร์ฟเวอร์ล้มเหลว (บันทึกข้อมูล)', 'error');
                console.error('Fetch error (saveAttendance):', error);
            } finally {
                hideLoader();
            }
        }
        
        function updateDailySummary(records) {
            let presentCount = 0;
            let sickCount = 0;
            let leaveCount = 0;
            let absentCount = 0;
            const totalStudents = records.length;

            records.forEach(record => {
                switch (record.status) {
                    case 'Present': presentCount++; break;
                    case 'Sick': sickCount++; break;
                    case 'Leave': leaveCount++; break;
                    case 'Absent': absentCount++; break;
                }
            });

            const presentPercent = totalStudents > 0 ? ((presentCount / totalStudents) * 100).toFixed(1) : 0;
            
            summaryContent.innerHTML = `
                <div class="p-3 bg-green-100 rounded-lg text-center">
                    <p class="text-2xl font-bold text-green-700">${presentCount}</p>
                    <p class="text-sm text-green-600">มาเรียน (${presentPercent}%)</p>
                </div>
                <div class="p-3 bg-red-100 rounded-lg text-center">
                    <p class="text-2xl font-bold text-red-700">${sickCount}</p>
                    <p class="text-sm text-red-600">ป่วย</p>
                </div>
                <div class="p-3 bg-yellow-100 rounded-lg text-center">
                    <p class="text-2xl font-bold text-yellow-700">${leaveCount}</p>
                    <p class="text-sm text-yellow-600">ลา</p>
                </div>
                <div class="p-3 bg-orange-100 rounded-lg text-center">
                    <p class="text-2xl font-bold text-orange-700">${absentCount}</p>
                    <p class="text-sm text-orange-600">ขาด</p>
                </div>
            `;
            dailySummarySection.classList.remove('hidden');
        }

        // --- HISTORY & FILTERING ---
        async function loadAttendanceHistory(page = 1) {
            showLoader();
            currentHistoryPage = page;
            const gradeFilter = historyGradeFilter.value;

            const payload = {
                action: 'getAttendanceHistory',
                sheetId: SHEET_ID,
                page: currentHistoryPage,
                limit: HISTORY_ITEMS_PER_PAGE,
                gradeFilter: gradeFilter
            };

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'application/json'}
                });
                const result = await response.json();

                if (result.success) {
                    allHistoryData = result.data; // Store all data if backend sends it all, or just current page
                    totalHistoryPages = result.totalPages || 1;
                    renderHistoryTable(result.data); // result.data should be the paged data
                    renderPaginationControls();
                    if (result.data.length === 0) {
                        showToast('ไม่พบประวัติการบันทึก', 'success');
                        historyTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4">ไม่พบข้อมูลประวัติ</td></tr>';
                    }
                } else {
                    showToast(result.message || 'เกิดข้อผิดพลาดในการโหลดประวัติ', 'error');
                    historyTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4">ไม่สามารถโหลดข้อมูลได้</td></tr>';
                }
            } catch (error) {
                showToast('การเชื่อมต่อกับเซิร์ฟเวอร์ล้มเหลว (โหลดประวัติ)', 'error');
                console.error('Fetch error (loadAttendanceHistory):', error);
                historyTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4">การเชื่อมต่อล้มเหลว</td></tr>';
            } finally {
                hideLoader();
            }
        }

        function renderHistoryTable(historyItems) {
            historyTableBody.innerHTML = '';
            if (!historyItems || historyItems.length === 0) {
                 historyTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4">ไม่พบข้อมูลประวัติ</td></tr>';
                 return;
            }
            historyItems.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${new Date(item.submissionTimestamp).toLocaleString('th-TH')}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${new Date(item.attendanceDate).toLocaleDateString('th-TH')}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${item.grade}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${item.semester}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${item.academicYear}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${item.studentCount}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm">
                        <button class="text-green-600 hover:text-green-800 view-history-detail-btn" data-history-id="${item.id || item.submissionTimestamp}">ดูรายละเอียด</button>
                    </td>
                `;
                historyTableBody.appendChild(row);
            });
            
            document.querySelectorAll('.view-history-detail-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const historyId = e.target.dataset.historyId;
                    // Implement viewing details: could be a modal or loading this specific record into the main attendance view
                    showToast(`กำลังโหลดรายละเอียดสำหรับ ID: ${historyId} (ฟังก์ชันนี้ต้องพัฒนาเพิ่มเติม)`, 'success');
                    // For now, just log. In a full app, you'd fetch and display the detailed record.
                    console.log("View details for history ID:", historyId);
                    // Example: Find the item and populate the main form (if it matches current structure)
                    // const detailItem = allHistoryData.find(d => (d.id || d.submissionTimestamp) === historyId);
                    // if (detailItem && detailItem.records) {
                    //    populateAttendanceFromHistory(detailItem);
                    // }
                });
            });
        }
        
        function renderPaginationControls() {
            paginationControls.innerHTML = '';
            if (totalHistoryPages <= 1) return;

            // Previous Button
            const prevButton = document.createElement('button');
            prevButton.textContent = 'ก่อนหน้า';
            prevButton.classList.add('px-3', 'py-1', 'border', 'rounded-md', 'text-sm');
            prevButton.disabled = currentHistoryPage === 1;
            prevButton.onclick = () => loadAttendanceHistory(currentHistoryPage - 1);
            if(prevButton.disabled) prevButton.classList.add('opacity-50', 'cursor-not-allowed');
            else prevButton.classList.add('hover:bg-gray-100');
            paginationControls.appendChild(prevButton);

            // Page Numbers (simplified for brevity, could add more complex logic for many pages)
            for (let i = 1; i <= totalHistoryPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.classList.add('px-3', 'py-1', 'border', 'rounded-md', 'text-sm');
                if (i === currentHistoryPage) {
                    pageButton.classList.add('bg-green-500', 'text-white');
                } else {
                    pageButton.classList.add('hover:bg-gray-100');
                }
                pageButton.onclick = () => loadAttendanceHistory(i);
                paginationControls.appendChild(pageButton);
            }

            // Next Button
            const nextButton = document.createElement('button');
            nextButton.textContent = 'ถัดไป';
            nextButton.classList.add('px-3', 'py-1', 'border', 'rounded-md', 'text-sm');
            nextButton.disabled = currentHistoryPage === totalHistoryPages;
            nextButton.onclick = () => loadAttendanceHistory(currentHistoryPage + 1);
             if(nextButton.disabled) nextButton.classList.add('opacity-50', 'cursor-not-allowed');
            else nextButton.classList.add('hover:bg-gray-100');
            paginationControls.appendChild(nextButton);
        }

        // --- DATA EXPORT ---
        function exportToExcel() {
            // This will redirect to a special Apps Script URL that serves the Excel file.
            // The Apps Script needs a doGet function to handle this.
            showLoader();
            const excelUrl = `${API_ENDPOINT}?action=exportExcel&sheetId=${SHEET_ID}&grade=${gradeLevelSelect.value}&date=${datePicker.value}&semester=${semesterSelect.value}&academicYear=${academicYearSelect.value}`;
            // It's better to trigger a download directly if the backend is set up for it.
            // For simplicity, this might just open a new tab to the sheet or a download link.
            // A more robust way is for Apps Script to return a temporary download URL or file content.
            // For now, we'll assume the Apps Script `doGet` handles the file generation and download trigger.
            
            // Construct the payload for exporting current view if needed, or specific parameters
            const payload = {
                action: 'exportExcel',
                sheetId: SHEET_ID,
                // Include filters if you want to export specific data
                // For example, export the currently displayed attendance or a summary
                date: datePicker.value,
                grade: gradeLevelSelect.value,
                semester: semesterSelect.value,
                academicYear: academicYearSelect.value,
                // You might want to send the actual attendanceData if exporting the current view
                // records: Object.values(attendanceData).filter(r => r.status) // only if student has data
            };

            fetch(API_ENDPOINT, {
                method: 'POST',
                body: JSON.stringify(payload),
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.blob(); // Expecting a blob for file download
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                // a.download = `attendance_export_${new Date().toISOString().split('T')[0]}.xlsx`; // Or get filename from header
                // Try to get filename from Content-Disposition header
                // const disposition = response.headers.get('Content-Disposition');
                // if (disposition && disposition.indexOf('attachment') !== -1) {
                //     var filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                //     var matches = filenameRegex.exec(disposition);
                //     if (matches != null && matches[1]) { 
                //       a.download = matches[1].replace(/['"]/g, '');
                //     }
                // }
                // For now, use a generic name
                a.download = `Attendance_Export_${payload.grade}_${payload.date}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
                showToast('กำลังเริ่มดาวน์โหลดไฟล์ Excel...', 'success');
            })
            .catch(error => {
                console.error('Excel export error:', error);
                showToast('เกิดข้อผิดพลาดในการส่งออก Excel: ' + error.message, 'error');
            })
            .finally(() => {
                hideLoader();
            });
        }

        function exportToPdf() {
            // Simple browser print functionality
            showToast('เตรียมหน้าสำหรับพิมพ์เป็น PDF...', 'success');
            // Optionally hide irrelevant sections for printing
            document.getElementById('controls').style.display = 'none';
            document.getElementById('historySection').style.display = 'none';
            document.getElementById('exportSection').style.display = 'none';
            document.querySelector('header').style.display = 'none';
            document.querySelector('footer').style.display = 'none';
            
            // Ensure the sections to print are visible
            if (attendanceSection.classList.contains('hidden')) {
                showToast('ไม่มีข้อมูลการเข้าเรียนให้พิมพ์ กรุณาโหลดรายชื่อนักเรียนก่อน', 'error');
            } else {
                 window.print();
            }

            // Restore visibility after print dialog
            document.getElementById('controls').style.display = 'block'; // Or its original display style
            document.getElementById('historySection').style.display = 'block';
            document.getElementById('exportSection').style.display = 'block';
            document.querySelector('header').style.display = 'block';
            document.querySelector('footer').style.display = 'block';
        }
        
        // --- EVENT LISTENERS ---
        loadStudentsBtn.addEventListener('click', loadStudents);
        saveAttendanceBtn.addEventListener('click', saveAttendance);
        loadHistoryBtn.addEventListener('click', () => loadAttendanceHistory(1)); // Load first page on click
        historyGradeFilter.addEventListener('change', () => loadAttendanceHistory(1)); // Reload on filter change
        exportExcelBtn.addEventListener('click', exportToExcel);
        exportPdfBtn.addEventListener('click', exportToPdf);

        // --- INITIAL LOAD ---
        initializeControls();
        loadAttendanceHistory(); // Load history on page startup

        // --- DEBUG/TESTING: Pre-populate with initial students (as per requirement) ---
        // This part is for demonstration. In a real scenario, `loadStudents` fetches from backend.
        // If you want to pre-populate for testing without backend:
        /*
        function populateInitialStudentsForDemo() {
            students = [
                { studentId: "111111", studentNumber: "1", fullName: "เด็กชาย ขยัน อดทน (Dekchay Khayan Odton)", photoUrl: "https://placehold.co/40x40/10B981/FFFFFF?text=KO", gradeLevel: "P.4" },
                { studentId: "222222", studentNumber: "2", fullName: "เด็กชาย ใจดี มีเมตตา (Dekchay Jaidee Meemetta)", photoUrl: "https://placehold.co/40x40/10B981/FFFFFF?text=JM", gradeLevel: "P.4" }
            ];
            // Filter by selected grade if needed, or assume these match the default selected grade
            const selectedGrade = gradeLevelSelect.value;
            students = students.filter(s => s.gradeLevel === selectedGrade);

            if (students.length > 0) {
                renderAttendanceTable();
                attendanceSection.classList.remove('hidden');
                teacherNotesSection.classList.remove('hidden');
            } else {
                 attendanceSection.classList.add('hidden');
                 teacherNotesSection.classList.add('hidden');
            }
        }
        // If you want to use the demo population:
        // gradeLevelSelect.addEventListener('change', populateInitialStudentsForDemo); // Re-populate on grade change
        // populateInitialStudentsForDemo(); // Initial population for demo
        */

    </script>
</body>
</html>
