<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกเวลาเรียน - โรงเรียนบ้านหนองกก</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #e8f5e9; /* Light green background */
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px; /* Add margin below main container */
        }
        h1, h2 {
            color: #1b5e20; /* Dark green */
            text-align: center;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        .controls label {
            margin-right: 10px;
            font-weight: bold;
        }
        .controls select, .controls input[type="date"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 10px;
            margin-bottom: 10px; /* Add margin for wrapping */
        }
        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .attendance-table th, .attendance-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        .attendance-table th {
            background-color: #4caf50; /* Green */
            color: white;
        }
        .attendance-table td {
            background-color: #f9f9f9;
        }
        .status-select {
            padding: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        /* Status Colors */
        .status-present { background-color: #a5d6a7; } /* Light Green */
        .status-sick { background-color: #ef9a9a; } /* Light Red */
        .status-leave { background-color: #ffe082; } /* Light Yellow */
        .status-absent { background-color: #ffcc80; } /* Light Orange */

        .notes-section {
            margin-top: 20px;
        }
        .notes-section textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            min-height: 100px;
        }
        .save-button {
            display: block;
            width: 100%;
            padding: 10px;
            background-color: #4caf50; /* Green */
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .save-button:hover {
            background-color: #388e3c; /* Darker green on hover */
        }
        .confirmation-message {
            text-align: center;
            color: #2e7d32; /* Dark green */
            margin-top: 15px;
            font-weight: bold;
            display: none; /* Hidden by default */
        }
        .statistics {
            margin-top: 20px;
            text-align: center;
            font-weight: bold;
        }
         .error-message {
            text-align: center;
            color: #c62828; /* Dark Red */
            margin-top: 15px;
            font-weight: bold;
            display: none; /* Hidden by default */
        }

        /* Student Management Section */
        .student-management-container {
             max-width: 900px;
            margin: 20px auto; /* Add margin top and bottom */
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .student-management-container h2 {
            color: #1b5e20; /* Dark green */
            text-align: center;
            margin-bottom: 20px;
        }
        .student-form {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            align-items: flex-end; /* Align items to the bottom */
        }
        .student-form input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            flex-grow: 1; /* Allow inputs to grow */
            min-width: 150px; /* Minimum width for inputs */
        }
         .student-form button {
            padding: 8px 15px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .student-form button:hover {
            background-color: #388e3c;
        }
        .student-list {
            list-style: none;
            padding: 0;
        }
        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .student-item:last-child {
            border-bottom: none;
        }
        .student-item span {
            flex-grow: 1;
            margin-right: 10px;
        }
        .student-item button {
            padding: 5px 10px;
            margin-left: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .student-item .edit-button {
            background-color: #ff9800; /* Orange */
            color: white;
        }
         .student-item .edit-button:hover {
            background-color: #f57c00; /* Darker Orange */
        }
        .student-item .delete-button {
            background-color: #f44336; /* Red */
            color: white;
        }
         .student-item .delete-button:hover {
            background-color: #d32f2f; /* Darker Red */
        }

        /* Login Section */
        .login-container {
            max-width: 400px;
            margin: 80px auto; /* Center vertically and horizontally */
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .login-container h2 {
            color: #1b5e20;
            margin-bottom: 20px;
        }
        .login-form input {
            width: calc(100% - 20px); /* Adjust for padding */
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .login-form button {
            width: 100%;
            padding: 10px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .login-form button:hover {
            background-color: #388e3c;
        }
        .login-error {
            color: #c62828;
            margin-top: 15px;
            display: none; /* Hidden by default */
        }

        /* Header with Logout */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .app-header h1 {
            margin: 0;
            text-align: left; /* Align title to the left in header */
        }
        .logout-button {
            padding: 8px 15px;
            background-color: #f44336; /* Red */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
         .logout-button:hover {
            background-color: #d32f2f; /* Darker Red */
        }

        /* Export Buttons */
        .export-buttons {
            margin-top: 20px;
            text-align: center;
        }
        .export-buttons button {
            padding: 10px 20px;
            margin: 0 10px;
            background-color: #0277bd; /* Light Blue */
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .export-buttons button:hover {
            background-color: #01579b; /* Darker Blue */
        }


        /* Responsive adjustments */
        @media (max-width: 600px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            .controls select, .controls input[type="date"] {
                 margin-right: 0;
            }
             .student-form {
                flex-direction: column;
                align-items: stretch;
            }
             .student-form input, .student-form button {
                width: 100%; /* Full width on small screens */
                margin-right: 0;
            }
             .student-item {
                flex-direction: column;
                align-items: flex-start;
            }
             .student-item span {
                margin-bottom: 5px;
                margin-right: 0;
            }
             .student-item button {
                margin-left: 0;
                margin-right: 5px;
            }
             .login-container {
                margin: 40px auto; /* Adjust margin for smaller screens */
                padding: 20px;
            }
             .app-header {
                flex-direction: column;
                align-items: center;
            }
            .app-header h1 {
                text-align: center; /* Center title in header on small screens */
                margin-bottom: 10px;
            }
             .export-buttons button {
                display: block;
                width: 100%;
                margin: 10px 0; /* Stack buttons vertically */
            }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

    <div class="login-container" id="login-container">
        <h2>เข้าสู่ระบบ</h2>
        <div class="login-form">
            <input type="email" id="login-email" placeholder="อีเมล">
            <input type="password" id="login-password" placeholder="รหัสผ่าน">
            <button onclick="login()">เข้าสู่ระบบ</button>
            <div class="login-error" id="login-error"></div>
        </div>
    </div>

    <div id="main-app-content" style="display: none;">
        <div class="container">
            <div class="app-header">
                 <h1>ระบบบันทึกเวลาเรียน</h1>
                 <button class="logout-button" onclick="logout()">ออกจากระบบ</button>
            </div>
            <h2>ชั้นประถมศึกษาปีที่ 5</h2>

            <div class="controls">
                <div>
                    <label for="attendance-date">วันที่:</label>
                    <input type="date" id="attendance-date">
                </div>
                <div>
                    <label for="semester">ภาคเรียน:</label>
                    <select id="semester">
                        <option value="1">ภาคเรียนที่ 1</option>
                        <option value="2">ภาคเรียนที่ 2</option>
                    </select>
                </div>
                <div>
                    <label for="academic-year">ปีการศึกษา:</label>
                    <select id="academic-year">
                        </select>
                </div>
            </div>

            <table class="attendance-table" id="attendance-table">
                <thead>
                    <tr>
                        <th>เลขประจำตัว</th>
                        <th>เลขที่</th>
                        <th>ชื่อ-นามสกุล</th>
                        <th>สถานะ</th>
                    </tr>
                </thead>
                <tbody id="student-attendance-body">
                    </tbody>
            </table>

            <div class="statistics">
                เปอร์เซ็นต์นักเรียนที่มาเรียนวันนี้: <span id="present-percentage">0%</span>
            </div>

            <div class="notes-section">
                <h3>บันทึกเพิ่มเติม</h3>
                <textarea id="teacher-notes" placeholder="บันทึกข้อสังเกตพฤติกรรมนักเรียน..."></textarea>
            </div>

            <button class="save-button" onclick="saveAttendance()">บันทึกข้อมูล</button>

            <div class="confirmation-message" id="save-confirmation">
                บันทึกข้อมูลเรียบร้อย!
            </div>
             <div class="error-message" id="error-message">
                เกิดข้อผิดพลาดในการบันทึกข้อมูล.
            </div>

            <div class="export-buttons">
                <button onclick="exportToPdf()">ส่งออกเป็น PDF</button>
                <button onclick="exportToCsv()">ส่งออกเป็น CSV (สำหรับ Excel)</button>
            </div>

        </div>

        <div class="student-management-container">
            <h2>จัดการข้อมูลนักเรียน</h2>

            <div class="student-form">
                <input type="text" id="student-id" placeholder="เลขประจำตัว">
                <input type="number" id="student-number" placeholder="เลขที่">
                <input type="text" id="student-name" placeholder="ชื่อ-นามสกุล">
                <button onclick="addOrUpdateStudent()">เพิ่ม/แก้ไข นักเรียน</button>
            </div>

            <ul class="student-list" id="student-list">
                </ul>
        </div>
    </div>


    <script type="text/javascript">
        // --- Firebase Configuration ---
        // Replace with your actual Firebase project configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBrGSCIQjT1V-dmR3LQaB-hkrSi_yWcg_I",
  authDomain: "attendance-system-c5235.firebaseapp.com",
    databaseURL: "https://attendance-system-c5235-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "attendance-system-c5235",
  storageBucket: "attendance-system-c5235.firebasestorage.app",
  messagingSenderId: "687349069254",
  appId: "1:687349069254:web:1bf765f9f0bafb86f1eec7",
  measurementId: "G-TZJ0F2EXTE"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth(); // Get Firebase Auth instance
        const studentsRef = database.ref('students'); // Reference to the 'students' node
        // --- End Firebase Configuration ---

        let students = []; // Array to hold student data loaded from Firebase

        // Get references to the main content and login containers
        const mainAppContent = document.getElementById('main-app-content');
        const loginContainer = document.getElementById('login-container');
        const loginError = document.getElementById('login-error');

        // Variable to store the unsubscribe function for the student listener
        let studentsListener = null;


        // --- Authentication Functions ---

        // Function to handle user login
        function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            loginError.textContent = ''; // Clear previous errors

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Signed in
                    const user = userCredential.user;
                    console.log("User logged in:", user.email);
                    // The onAuthStateChanged listener will handle showing the main content
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    console.error("Login error:", errorCode, errorMessage);
                    // Display error message to the user
                    loginError.textContent = `เข้าสู่ระบบไม่สำเร็จ: ${errorMessage}`;
                    loginError.style.display = 'block';
                });
        }

        // Function to handle user logout
        function logout() {
            auth.signOut().then(() => {
                // Sign-out successful.
                console.log("User logged out");
                // The onAuthStateChanged listener will handle showing the login page
            }).catch((error) => {
                // An error happened.
                 console.error("Logout error:", error);
                 // Optionally display an error message for logout
            });
        }

        // Listen for authentication state changes
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in.
                console.log("Auth state changed: User is signed in.");
                loginContainer.style.display = 'none'; // Hide login form
                mainAppContent.style.display = 'block'; // Show main content
                 loginError.style.display = 'none'; // Hide any login errors

                // Load necessary data after login
                populateAcademicYears();
                // Set default date to today and load attendance
                const today = new Date().toISOString().split('T')[0];
                const attendanceDateInput = document.getElementById('attendance-date');
                attendanceDateInput.value = today;

                // Start the real-time listener for students
                startStudentListener();

                 // Add event listener to date input to load data when date changes
                attendanceDateInput.addEventListener('change', (event) => {
                    loadAttendance(event.target.value);
                });


            } else {
                // User is signed out.
                console.log("Auth state changed: User is signed out.");
                mainAppContent.style.display = 'none'; // Hide main content
                loginContainer.style.display = 'block'; // Show login form

                 // Stop the real-time listener for students when logged out
                 stopStudentListener();

                 // Clear any sensitive data or state if needed
                 students = [];
                 document.getElementById('student-attendance-body').innerHTML = '';
                 document.getElementById('student-list').innerHTML = '';
                 document.getElementById('teacher-notes').value = '';
                 document.getElementById('present-percentage').textContent = '0%';
                 document.getElementById('academic-year').innerHTML = ''; // Clear academic years
                 document.getElementById('semester').value = '1'; // Reset semester
            }
        });


        // --- Attendance and Student Management Functions ---

        // Function to populate academic years
        function populateAcademicYears() {
            const yearSelect = document.getElementById('academic-year');
            yearSelect.innerHTML = ''; // Clear existing options
            const currentYear = new Date().getFullYear();
            // Assuming academic year starts around May
            const startYear = (new Date().getMonth() >= 4) ? currentYear : currentYear - 1;
            for (let i = 0; i < 5; i++) { // Populate 5 years back
                const year = startYear - i;
                const option = document.createElement('option');
                option.value = year;
                option.textContent = `ปีการศึกษา ${year + 543}`; // Buddhist Era
                yearSelect.appendChild(option);
            }
        }

        // Function to populate the attendance table using the loaded students array
        function populateAttendanceTable() {
            const tbody = document.getElementById('student-attendance-body');
            tbody.innerHTML = ''; // Clear existing rows

            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ไม่พบข้อมูลนักเรียน กรุณาเพิ่มข้อมูลนักเรียนในส่วนจัดการข้อมูลนักเรียน</td></tr>';
                return;
            }

            students.forEach(student => {
                const row = document.createElement('tr');
                row.setAttribute('data-student-id', student.id); // Add data attribute for ID

                row.innerHTML = `
                    <td>${student.id}</td>
                    <td>${student.number}</td>
                    <td>${student.name}</td>
                    <td>
                        <select class="status-select" onchange="updateRowColor(this)">
                            <option value="present">มาเรียน</option>
                            <option value="sick">ป่วย</option>
                            <option value="leave">ลา</option>
                            <option value="absent">ขาด</option>
                        </select>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Function to update row color based on status selection
        function updateRowColor(selectElement) {
            const row = selectElement.closest('tr');
            const status = selectElement.value;

            // Remove existing status classes
            row.classList.remove('status-present', 'status-sick', 'status-leave', 'status-absent');

            // Add the class corresponding to the selected status
            if (status === 'present') {
                row.classList.add('status-present');
            } else if (status === 'sick') {
                row.classList.add('status-sick');
            } else if (status === 'leave') {
                row.classList.add('status-leave');
            } else if (status === 'absent') {
                row.classList.add('status-absent');
            }

            calculatePresentPercentage(); // Recalculate percentage after status change
        }

        // Function to calculate and display the percentage of students present
        function calculatePresentPercentage() {
            const rows = document.querySelectorAll('#student-attendance-body tr');
            let presentCount = 0;
            rows.forEach(row => {
                const statusSelect = row.querySelector('.status-select');
                if (statusSelect && statusSelect.value === 'present') {
                    presentCount++;
                }
            });

            const totalStudents = students.length;
            const percentage = totalStudents > 0 ? (presentCount / totalStudents) * 100 : 0;
            document.getElementById('present-percentage').textContent = `${percentage.toFixed(0)}%`;
        }

        // Function to save attendance data to Firebase
        function saveAttendance() {
            // Check if user is logged in before saving
            if (!auth.currentUser) {
                alert("กรุณาเข้าสู่ระบบก่อนบันทึกข้อมูล"); // Please log in before saving
                return;
            }

            const attendanceDate = document.getElementById('attendance-date').value;
             if (!attendanceDate) {
                alert("กรุณาเลือกวันที่บันทึกข้อมูล"); // Please select a date
                return;
            }
             if (students.length === 0) {
                 alert("ไม่พบข้อมูลนักเรียน กรุณาเพิ่มข้อมูลนักเรียนก่อนบันทึกเวลาเรียน"); // No student data found, please add student data before saving attendance
                 return;
             }
            const semester = document.getElementById('semester').value;
            const academicYear = document.getElementById('academic-year').value;
            const teacherNotes = document.getElementById('teacher-notes').value;
            const timestamp = new Date().toISOString(); // ISO 8601 format

            const attendanceRecords = [];
            const rows = document.querySelectorAll('#student-attendance-body tr');
            rows.forEach(row => {
                const studentId = row.getAttribute('data-student-id');
                const statusSelect = row.querySelector('.status-select');
                if (statusSelect) {
                    attendanceRecords.push({
                        studentId: studentId,
                        status: statusSelect.value
                    });
                }
            });

            const attendanceData = {
                date: attendanceDate,
                semester: semester,
                academicYear: academicYear,
                timestamp: timestamp,
                notes: teacherNotes,
                records: attendanceRecords,
                recordedBy: auth.currentUser.email // Store who recorded the attendance
            };

            // Use the date as the key for storing attendance data
            const dateKey = attendanceDate.replace(/-/g, ''); // Remove hyphens for a valid key

            // Save data to Firebase Realtime Database
            database.ref('attendance/' + dateKey).set(attendanceData)
                .then(() => {
                    console.log("Attendance data saved successfully!");
                    // Show confirmation message
                    const confirmationMessage = document.getElementById('save-confirmation');
                    confirmationMessage.style.display = 'block';
                     const errorMessage = document.getElementById('error-message');
                    errorMessage.style.display = 'none';


                    // Hide confirmation message after a few seconds
                    setTimeout(() => {
                        confirmationMessage.style.display = 'none';
                    }, 3000); // Hide after 3 seconds
                })
                .catch((error) => {
                    console.error("Error saving attendance data:", error);
                     // Show error message
                    const errorMessage = document.getElementById('error-message');
                    errorMessage.textContent = `เกิดข้อผิดพลาดในการบันทึกข้อมูล: ${error.message}`;
                    errorMessage.style.display = 'block';
                     const confirmationMessage = document.getElementById('save-confirmation');
                    confirmationMessage.style.display = 'none';
                });
        }

        // Function to load attendance data from Firebase for a specific date
        function loadAttendance(date) {
             // Check if user is logged in before loading
            if (!auth.currentUser) {
                console.log("User not logged in, cannot load attendance.");
                return;
            }

            const dateKey = date.replace(/-/g, '');
            const teacherNotesTextarea = document.getElementById('teacher-notes');
            const tbody = document.getElementById('student-attendance-body');

            // Clear previous data display and reset table
            populateAttendanceTable(); // Reset table to default status
            teacherNotesTextarea.value = ''; // Clear notes

            database.ref('attendance/' + dateKey).once('value')
                .then((snapshot) => {
                    const attendanceData = snapshot.val();
                    if (attendanceData) {
                        console.log("Loaded attendance data:", attendanceData);

                        // Populate the table with loaded data
                        if (attendanceData.records) {
                            attendanceData.records.forEach(record => {
                                const row = tbody.querySelector(`tr[data-student-id='${record.studentId}']`);
                                if (row) {
                                    const statusSelect = row.querySelector('.status-select');
                                    if (statusSelect) {
                                        statusSelect.value = record.status;
                                        updateRowColor(statusSelect); // Update color based on loaded status
                                    }
                                }
                            });
                        }

                        // Populate the notes section
                        if (attendanceData.notes) {
                            teacherNotesTextarea.value = attendanceData.notes;
                        }

                        calculatePresentPercentage(); // Calculate percentage based on loaded data

                    } else {
                        console.log("No attendance data found for this date. Displaying default.");
                        // Table is already reset by populateAttendanceTable()
                        calculatePresentPercentage(); // Calculate percentage for default state
                    }
                })
                .catch((error) => {
                    console.error("Error loading attendance data:", error);
                     const errorMessage = document.getElementById('error-message');
                    errorMessage.textContent = `เกิดข้อผิดพลาดในการโหลดข้อมูล: ${error.message}`;
                    errorMessage.style.display = 'block';
                });
        }

        // --- Student CRUD Functions ---

        // Function to render the list of students in the management section
        function renderStudentList() {
            const studentListUl = document.getElementById('student-list');
            studentListUl.innerHTML = ''; // Clear existing list

            if (students.length === 0) {
                 const listItem = document.createElement('li');
                 listItem.textContent = "ไม่พบข้อมูลนักเรียน";
                 studentListUl.appendChild(listItem);
                 return;
            }

            students.forEach(student => {
                const listItem = document.createElement('li');
                listItem.classList.add('student-item');
                listItem.setAttribute('data-student-id', student.id); // Use student ID as data attribute

                listItem.innerHTML = `
                    <span>${student.number}. ${student.name} (ID: ${student.id})</span>
                    <div>
                        <button class="edit-button" onclick="editStudent('${student.id}')">แก้ไข</button>
                        <button class="delete-button" onclick="deleteStudent('${student.id}')">ลบ</button>
                    </div>
                `;
                studentListUl.appendChild(listItem);
            });
        }

        // Function to add or update a student in Firebase
        function addOrUpdateStudent() {
             // Check if user is logged in before saving
            if (!auth.currentUser) {
                alert("กรุณาเข้าสู่ระบบก่อนจัดการข้อมูลนักเรียน"); // Please log in before managing student data
                return;
            }

            const studentIdInput = document.getElementById('student-id');
            const studentNumberInput = document.getElementById('student-number');
            const studentNameInput = document.getElementById('student-name');

            const studentId = studentIdInput.value.trim();
            const studentNumber = parseInt(studentNumberInput.value.trim(), 10);
            const studentName = studentNameInput.value.trim();

            if (!studentId || !studentName || isNaN(studentNumber)) {
                alert("กรุณากรอกข้อมูลนักเรียนให้ครบถ้วน (เลขประจำตัว, เลขที่, ชื่อ-นามสกุล)");
                return;
            }

            const studentData = {
                id: studentId,
                number: studentNumber,
                name: studentName,
                photo: '' // Placeholder for photo URL
            };

            // Use student ID as the key in Firebase
            studentsRef.child(studentId).set(studentData)
                .then(() => {
                    console.log("Student data saved successfully:", studentData);
                    // Clear the form
                    studentIdInput.value = '';
                    studentNumberInput.value = '';
                    studentNameInput.value = '';
                    // No need to call loadStudents() here, the listener will handle the update
                })
                .catch((error) => {
                    console.error("Error saving student data:", error);
                     const errorMessage = document.getElementById('error-message');
                    errorMessage.textContent = `เกิดข้อผิดพลาดในการบันทึกข้อมูลนักเรียน: ${error.message}`;
                    errorMessage.style.display = 'block';
                });
        }

        // Function to start the real-time listener for students
        function startStudentListener() {
             // Check if user is logged in before starting listener
            if (!auth.currentUser) {
                 console.log("User not logged in, cannot start student listener.");
                return;
            }

            // Remove any existing listener to avoid duplicates
            stopStudentListener();

            studentsListener = studentsRef.on('value', (snapshot) => {
                const studentsData = snapshot.val();
                students = []; // Clear the current students array
                if (studentsData) {
                    // Convert the object of students to an array
                    for (const studentId in studentsData) {
                        students.push(studentsData[studentId]);
                    }
                     // Sort students by number
                    students.sort((a, b) => a.number - b.number);
                    console.log("Students data updated:", students);
                } else {
                     console.log("No students found in database.");
                }
                // Render the student list and populate the attendance table whenever data changes
                renderStudentList();
                populateAttendanceTable();

                // After students are updated, reload attendance for the current date
                 const currentDate = document.getElementById('attendance-date').value;
                 if (currentDate) {
                     loadAttendance(currentDate);
                 } else {
                     // If no date is set, calculate percentage for the default empty state
                     calculatePresentPercentage();
                 }

            }, (error) => {
                console.error("Error in student listener:", error);
                 const errorMessage = document.getElementById('error-message');
                errorMessage.textContent = `เกิดข้อผิดพลาดในการอัปเดตข้อมูลนักเรียนแบบเรียลไทม์: ${error.message}`;
                errorMessage.style.display = 'block';
            });
             console.log("Student listener started.");
        }

        // Function to stop the real-time listener for students
        function stopStudentListener() {
            if (studentsListener) {
                studentsRef.off('value', studentsListener);
                studentsListener = null;
                console.log("Student listener stopped.");
            }
        }


        // Function to populate the form for editing a student
        function editStudent(studentId) {
             // Check if user is logged in before editing
            if (!auth.currentUser) {
                alert("กรุณาเข้าสู่ระบบก่อนแก้ไขข้อมูลนักเรียน"); // Please log in before editing student data
                return;
            }
            const student = students.find(s => s.id === studentId);
            if (student) {
                document.getElementById('student-id').value = student.id;
                document.getElementById('student-number').value = student.number;
                document.getElementById('student-name').value = student.name;
                // TODO: Populate photo input if implemented
            }
        }

        // Function to delete a student from Firebase
        function deleteStudent(studentId) {
             // Check if user is logged in before deleting
            if (!auth.currentUser) {
                alert("กรุณาเข้าสู่ระบบก่อนลบข้อมูลนักเรียน"); // Please log in before deleting student data
                return;
            }
            if (confirm(`คุณต้องการลบนักเรียน เลขประจำตัว ${studentId} ใช่หรือไม่?`)) {
                studentsRef.child(studentId).remove()
                    .then(() => {
                        console.log("Student data deleted successfully:", studentId);
                        // No need to call loadStudents() here, the listener will handle the update
                    })
                    .catch((error) => {
                        console.error("Error deleting student data:", error);
                         const errorMessage = document.getElementById('error-message');
                        errorMessage.textContent = `เกิดข้อผิดพลาดในการลบข้อมูลนักเรียน: ${error.message}`;
                        errorMessage.style.display = 'block';
                    });
            }
        }

        // --- Export Functions ---

        // Function to export attendance data to PDF
        function exportToPdf() {
             // Check if user is logged in before exporting
            if (!auth.currentUser) {
                alert("กรุณาเข้าสู่ระบบก่อนส่งออกข้อมูล"); // Please log in before exporting
                return;
            }

            const attendanceDate = document.getElementById('attendance-date').value;
            if (!attendanceDate) {
                alert("กรุณาเลือกวันที่ต้องการส่งออกข้อมูล"); // Please select a date to export
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFont('Sarabun', 'normal'); // Set Thai font (assuming Sarabun is available/embedded) - Note: Font embedding requires more advanced setup

            // Get table data
            const table = document.getElementById('attendance-table');
            const header = [];
            const rows = [];

            // Get header
            table.querySelectorAll('thead th').forEach(th => {
                header.push(th.textContent.trim());
            });

            // Get row data
            table.querySelectorAll('tbody tr').forEach(tr => {
                const rowData = [];
                tr.querySelectorAll('td').forEach((td, index) => {
                    if (index === 3) { // Status column
                         const selectElement = td.querySelector('.status-select');
                         rowData.push(selectElement ? selectElement.options[selectElement.selectedIndex].text : td.textContent.trim());
                    } else {
                         rowData.push(td.textContent.trim());
                    }
                });
                rows.push(rowData);
            });

            // Add title and date
            doc.setFontSize(18);
            doc.text(`รายงานบันทึกเวลาเรียน ชั้นประถมศึกษาปีที่ 5`, 14, 22);
            doc.setFontSize(12);
            doc.text(`วันที่: ${attendanceDate}`, 14, 30);

            // Add table
            doc.autoTable({
                startY: 40,
                head: [header],
                body: rows,
                theme: 'striped',
                headStyles: { fillColor: [76, 175, 80] }, // Green header
                styles: { font: 'Sarabun', fontStyle: 'normal' }, // Apply font to table
                didDrawPage: function (data) {
                    // Footer
                    let pageNumber = doc.internal.getNumberOfPages();
                    doc.setFontSize(10);
                    doc.text('Page ' + pageNumber, data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });

             // Add Notes section if available
             const teacherNotes = document.getElementById('teacher-notes').value.trim();
             if (teacherNotes) {
                 let finalY = doc.lastAutoTable.finalY; // Get the end Y position of the table
                 doc.setFontSize(12);
                 doc.text('บันทึกเพิ่มเติม:', 14, finalY + 20);
                 doc.setFontSize(10);
                 // Split notes into lines to fit within page width
                 const splitNotes = doc.splitTextToSize(teacherNotes, doc.internal.pageSize.width - 28); // 28 = left + right margin
                 doc.text(splitNotes, 14, finalY + 28);
             }


            // Save the PDF
            doc.save(`รายงานบันทึกเวลาเรียน_${attendanceDate}.pdf`);
        }

        // Function to export attendance data to CSV (for Excel)
        function exportToCsv() {
             // Check if user is logged in before exporting
            if (!auth.currentUser) {
                alert("กรุณาเข้าสู่ระบบก่อนส่งออกข้อมูล"); // Please log in before exporting
                return;
            }

            const attendanceDate = document.getElementById('attendance-date').value;
             if (!attendanceDate) {
                alert("กรุณาเลือกวันที่ต้องการส่งออกข้อมูล"); // Please select a date to export
                return;
            }

            const table = document.getElementById('attendance-table');
            let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF"; // Add BOM for UTF-8 in Excel

            // Get header
            table.querySelectorAll('thead th').forEach(th => {
                csvContent += `"${th.textContent.trim()}",`;
            });
            csvContent = csvContent.slice(0, -1) + "\n"; // Remove trailing comma and add newline

            // Get row data
            table.querySelectorAll('tbody tr').forEach(tr => {
                tr.querySelectorAll('td').forEach((td, index) => {
                     if (index === 3) { // Status column
                         const selectElement = td.querySelector('.status-select');
                         csvContent += `"${selectElement ? selectElement.options[selectElement.selectedIndex].text : td.textContent.trim()}",`;
                    } else {
                         csvContent += `"${td.textContent.trim()}",`;
                    }
                });
                csvContent = csvContent.slice(0, -1) + "\n"; // Remove trailing comma and add newline
            });

             // Add Notes section if available
             const teacherNotes = document.getElementById('teacher-notes').value.trim();
             if (teacherNotes) {
                 csvContent += `\n"บันทึกเพิ่มเติม:",\n"${teacherNotes.replace(/"/g, '""')}"\n`; // Handle quotes in notes
             }


            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `รายงานบันทึกเวลาเรียน_${attendanceDate}.csv`);
            document.body.appendChild(link); // Required for Firefox
            link.click(); // Trigger the download
            document.body.removeChild(link); // Clean up
        }


        // Initialize the page (This will now primarily set up the auth listener)
        window.onload = function() {
            // The onAuthStateChanged listener handles the initial display and data loading
            console.log("Window loaded. Waiting for authentication state.");
        };


    </script>

</body>
</html>
