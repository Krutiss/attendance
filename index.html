<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกเวลาเรียน - โรงเรียนบ้านหนองกก</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #e8f5e9; /* Light green background */
            color: #333;
            line-height: 1.6; /* Improve readability */
        }
        .container {
            max-width: 900px;
            margin: 20px auto; /* Add margin top and bottom for separation */
            background-color: #ffffff;
            padding: 30px; /* Increased padding */
            border-radius: 12px; /* More rounded corners */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Softer shadow */
        }
        h1, h2 {
            color: #1b5e20; /* Dark green */
            text-align: center;
            margin-bottom: 25px; /* Increased margin */
        }
         h2 {
             border-bottom: 2px solid #4caf50; /* Add a subtle underline */
             padding-bottom: 10px;
             margin-top: 20px;
         }
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px; /* Increased margin */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            background-color: #f1f8e9; /* Very light green background for controls */
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dcedc8; /* Subtle border */
        }
        .controls label {
            margin-right: 10px;
            font-weight: bold;
            color: #333;
        }
        .controls select, .controls input[type="date"] {
            padding: 10px; /* Increased padding */
            border: 1px solid #ccc;
            border-radius: 5px; /* Slightly more rounded */
            margin-right: 15px; /* Increased margin */
            margin-bottom: 10px; /* Add margin for wrapping */
            font-family: 'Sarabun', sans-serif;
            font-size: 1rem;
        }
         .controls button {
             padding: 10px 20px;
             background-color: #4caf50;
             color: white;
             border: none;
             border-radius: 5px;
             font-size: 1rem;
             cursor: pointer;
             transition: background-color 0.3s ease, transform 0.1s ease;
         }
         .controls button:hover {
             background-color: #388e3c;
             transform: translateY(-2px); /* Slight lift effect */
         }
         .controls button:active {
             transform: translateY(0);
         }

        .attendance-table, .analysis-table, .student-history-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); /* Subtle table shadow */
        }
        .attendance-table th, .attendance-table td,
        .analysis-table th, .analysis-table td,
        .student-history-table th, .student-history-table td {
            border: 1px solid #e0e0e0; /* Lighter border */
            padding: 12px; /* Increased padding */
            text-align: left;
        }
        .attendance-table th, .analysis-table th, .student-history-table th {
            background-color: #4caf50; /* Green */
            color: white;
            font-weight: bold;
            text-transform: uppercase; /* Uppercase headers */
            letter-spacing: 0.5px;
        }
         .attendance-table tbody tr:nth-child(even),
         .analysis-table tbody tr:nth-child(even),
         .student-history-table tbody tr:nth-child(even) {
             background-color: #f9f9f9; /* Slightly different background for even rows */
         }
         .attendance-table tbody tr:hover,
         .analysis-table tbody tr:hover,
         .student-history-table tbody tr:hover {
             background-color: #e0f2f7; /* Highlight row on hover */
         }

        .status-select {
            padding: 6px; /* Increased padding */
            border-radius: 5px; /* Slightly more rounded */
            cursor: pointer;
            font-family: 'Sarabun', sans-serif;
            font-size: 0.95rem;
            border: 1px solid #ccc; /* Add border */
        }
         .status-select option {
             padding: 5px; /* Padding for dropdown options */
         }
        /* Status Colors */
        .status-present { background-color: #a5d6a7; color: #1b5e20; font-weight: bold; } /* Light Green, Dark Green Text */
        .status-sick { background-color: #ef9a9a; color: #c62828; font-weight: bold; } /* Light Red, Dark Red Text */
        .status-leave { background-color: #ffe082; color: #f57c00; font-weight: bold; } /* Light Yellow, Dark Orange Text */
        .status-absent { background-color: #ffcc80; color: #e65100; font-weight: bold; } /* Light Orange, Dark Orange Text */

        .notes-section {
            margin-top: 30px; /* Increased margin */
            border-top: 1px solid #eee; /* Separator line */
            padding-top: 20px;
        }
        .notes-section h3 {
            color: #1b5e20;
            margin-bottom: 10px;
        }
        .notes-section textarea {
            width: 100%;
            padding: 12px; /* Increased padding */
            border: 1px solid #ccc;
            border-radius: 5px;
            min-height: 120px; /* Increased height */
            font-family: 'Sarabun', sans-serif;
            font-size: 1rem;
            resize: vertical; /* Allow vertical resizing */
        }
        .save-button {
            display: block;
            width: 100%;
            padding: 12px; /* Increased padding */
            background-color: #4caf50; /* Green */
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem; /* Slightly larger font */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            margin-top: 20px; /* Increased margin */
        }
        .save-button:hover {
            background-color: #388e3c; /* Darker green on hover */
            transform: translateY(-2px); /* Slight lift effect */
        }
         .save-button:active {
             transform: translateY(0);
         }
        .confirmation-message {
            text-align: center;
            color: #2e7d32; /* Dark green */
            margin-top: 15px;
            font-weight: bold;
            display: none; /* Hidden by default */
            padding: 10px;
            background-color: #dcedc8; /* Light green background */
            border: 1px solid #aed581; /* Green border */
            border-radius: 5px;
        }
        .statistics {
            margin-top: 20px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            color: #1b5e20; /* Dark green */
        }
         .error-message {
            text-align: center;
            color: #c62828; /* Dark Red */
            margin-top: 15px;
            font-weight: bold;
            display: none; /* Hidden by default */
            padding: 10px;
            background-color: #ffcdd2; /* Light red background */
            border: 1px solid #ef9a9a;
            border-radius: 5px;
        }

        /* Student Management Section */
        .student-management-container {
             max-width: 900px;
            margin: 20px auto;
            background-color: #ffffff;
            padding: 30px; /* Increased padding */
            border-radius: 12px; /* More rounded corners */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Softer shadow */
        }
        .student-management-container h2 {
            color: #1b5e20;
            text-align: center;
            margin-bottom: 25px;
             border-bottom: 2px solid #4caf50;
             padding-bottom: 10px;
             margin-top: 0; /* Remove top margin here */
        }
        .student-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px; /* Increased gap */
            margin-bottom: 25px; /* Increased margin */
            align-items: flex-end;
            background-color: #f1f8e9; /* Very light green background */
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dcedc8; /* Subtle border */
        }
        .student-form input[type="text"],
        .student-form input[type="number"],
        .student-form select { /* Added select to form styling */
            padding: 10px; /* Increased padding */
            border: 1px solid #ccc;
            border-radius: 5px;
            flex-grow: 1;
            min-width: 180px; /* Adjusted minimum width */
            font-family: 'Sarabun', sans-serif;
            font-size: 1rem;
        }
         .student-form input[type="file"] {
             padding: 8px; /* Slightly less padding for file input */
             border: 1px solid #ccc;
             border-radius: 5px;
             flex-grow: 1;
             min-width: 180px;
             font-family: 'Sarabun', sans-serif;
             font-size: 1rem;
             background-color: #ffffff; /* White background for file input */
         }
         .student-form button {
            padding: 10px 20px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
             font-size: 1rem;
        }
        .student-form button:hover {
            background-color: #388e3c;
             transform: translateY(-2px);
        }
         .student-form button:active {
             transform: translateY(0);
         }
        .student-list {
            list-style: none;
            padding: 0;
        }
        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px; /* Increased padding */
            border-bottom: 1px solid #eee;
            background-color: #ffffff; /* Ensure white background */
            transition: background-color 0.3s ease;
        }
        .student-item:hover {
            background-color: #e0f2f7; /* Highlight on hover */
        }
        .student-item:last-child {
            border-bottom: none;
        }
        .student-item span {
            flex-grow: 1;
            margin-right: 15px; /* Increased margin */
            font-size: 1rem;
        }
         .student-item .student-photo-preview {
             width: 40px;
             height: 40px;
             border-radius: 50%; /* Circular photo */
             margin-right: 10px;
             object-fit: cover; /* Cover the area */
             border: 2px solid #4caf50; /* Green border */
         }
        .student-item button {
            padding: 6px 12px; /* Adjusted padding */
            margin-left: 8px; /* Increased margin */
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            font-size: 0.9rem;
        }
         .student-item button:hover {
             transform: translateY(-1px);
         }
          .student-item button:active {
             transform: translateY(0);
         }
        .student-item .edit-button {
            background-color: #ff9800; /* Orange */
            color: white;
        }
         .student-item .edit-button:hover {
            background-color: #f57c00; /* Darker Orange */
        }
        .student-item .delete-button {
            background-color: #f44336; /* Red */
            color: white;
        }
         .student-item .delete-button:hover {
            background-color: #d32f2f; /* Darker Red */
        }

        /* Login Section */
        .login-container {
            max-width: 450px; /* Slightly wider */
            margin: 80px auto;
            background-color: #ffffff;
            padding: 40px; /* Increased padding */
            border-radius: 12px; /* More rounded corners */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); /* Stronger shadow */
            text-align: center;
        }
        .login-container h2 {
            color: #1b5e20;
            margin-bottom: 30px; /* Increased margin */
             border-bottom: none; /* No underline for login title */
             padding-bottom: 0;
        }
        .login-form input {
            width: calc(100% - 24px); /* Adjust for padding */
            padding: 12px; /* Increased padding */
            margin-bottom: 20px; /* Increased margin */
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: 'Sarabun', sans-serif;
            font-size: 1rem;
        }
        .login-form button {
            width: 100%;
            padding: 12px; /* Increased padding */
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        .login-form button:hover {
            background-color: #388e3c;
             transform: translateY(-2px);
        }
         .login-form button:active {
             transform: translateY(0);
         }
        .login-error {
            color: #c62828;
            margin-top: 20px; /* Increased margin */
            display: none;
            padding: 10px;
            background-color: #ffcdd2;
            border: 1px solid #ef9a9a;
            border-radius: 5px;
        }

        /* Header with Logout and View Toggle */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px; /* Increased margin */
            flex-wrap: wrap;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee; /* Separator */
        }
        .app-header h1 {
            margin: 0;
            text-align: left;
            flex-grow: 1;
            margin-bottom: 10px;
            font-size: 1.8rem; /* Slightly larger title */
        }
        .header-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .header-buttons button {
             padding: 8px 15px;
             border: none;
             border-radius: 5px; /* Slightly more rounded */
             cursor: pointer;
             transition: background-color 0.3s ease, transform 0.1s ease;
             font-size: 0.95rem;
        }
         .header-buttons button:hover {
             transform: translateY(-1px);
         }
          .header-buttons button:active {
             transform: translateY(0);
         }
        .view-button {
             background-color: #0288d1; /* Blue */
             color: white;
        }
         .view-button:hover {
             background-color: #0277bd; /* Darker Blue */
         }
        .logout-button {
            background-color: #f44336; /* Red */
            color: white;
        }
         .logout-button:hover {
            background-color: #d32f2f; /* Darker Red */
        }


        /* Export Buttons */
        .export-buttons {
            margin-top: 30px; /* Increased margin */
            text-align: center;
            border-top: 1px solid #eee; /* Separator line */
            padding-top: 20px;
        }
        .export-buttons button {
            padding: 10px 20px;
            margin: 0 10px;
            background-color: #0277bd; /* Light Blue */
            color: white;
            border: none;
            border-radius: 5px; /* Slightly more rounded */
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        .export-buttons button:hover {
            background-color: #01579b; /* Darker Blue */
             transform: translateY(-2px);
        }
         .export-buttons button:active {
             transform: translateY(0);
         }

        /* Comparative Analysis Section */
        .comparative-analysis-container {
             max-width: 900px;
            margin: 20px auto;
            background-color: #ffffff;
            padding: 30px; /* Increased padding */
            border-radius: 12px; /* More rounded corners */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Softer shadow */
             display: none;
        }
        .comparative-analysis-container h2 {
             color: #1b5e20;
            text-align: center;
            margin-bottom: 25px;
             border-bottom: 2px solid #4caf50;
             padding-bottom: 10px;
             margin-top: 0; /* Remove top margin here */
        }
         .comparative-analysis-container p {
             text-align: center;
             margin-bottom: 20px;
             color: #555;
         }
        .analysis-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .analysis-table th, .analysis-table td {
            border: 1px solid #e0e0e0;
            padding: 12px; /* Increased padding */
            text-align: left;
        }
        .analysis-table th {
            background-color: #4caf50;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
         .analysis-table tbody tr:nth-child(even) {
             background-color: #f9f9f9;
         }
          .analysis-table tbody tr:hover {
             background-color: #e0f2f7;
             cursor: pointer; /* Indicate clickable rows */
         }

         /* Student History Detail Section */
         .student-history-detail {
             margin-top: 30px;
             border-top: 1px solid #eee;
             padding-top: 20px;
             display: none; /* Hidden by default */
         }
         .student-history-detail h3 {
             color: #1b5e20;
             margin-bottom: 15px;
         }
         .student-history-detail .back-button {
             padding: 8px 15px;
             background-color: #546e7a; /* Blue Grey */
             color: white;
             border: none;
             border-radius: 5px;
             cursor: pointer;
             transition: background-color 0.3s ease;
             margin-bottom: 15px;
         }
          .student-history-detail .back-button:hover {
              background-color: #455a64; /* Darker Blue Grey */
          }
         .student-history-detail .history-list {
             list-style: none;
             padding: 0;
         }
         .student-history-detail .history-item {
             padding: 10px;
             border-bottom: 1px solid #eee;
         }
         .student-history-detail .history-item:last-child {
             border-bottom: none;
         }
         .student-history-detail .history-item span {
             margin-right: 15px;
         }


        /* Responsive adjustments */
        @media (max-width: 768px) { /* Adjusted breakpoint for tablets */
            body {
                padding: 10px; /* Reduced padding on smaller screens */
            }
            .container, .student-management-container, .login-container {
                padding: 20px; /* Reduced container padding */
            }
            .controls, .student-form {
                flex-direction: column;
                align-items: stretch;
                padding: 10px; /* Reduced padding */
            }
            .controls select, .controls input[type="date"],
            .student-form input, .student-form button, .student-form select { /* Added select */
                 margin-right: 0;
                 margin-bottom: 10px; /* Consistent margin */
                 width: 100%; /* Full width */
            }
             .student-item {
                flex-direction: column;
                align-items: flex-start;
                padding: 10px; /* Reduced padding */
            }
             .student-item span {
                margin-bottom: 8px; /* Adjusted margin */
                margin-right: 0;
            }
             .student-item button {
                margin-left: 0;
                margin-right: 5px;
                padding: 5px 10px; /* Adjusted padding */
            }
             .login-container {
                margin: 40px auto;
                padding: 20px;
            }
             .app-header {
                flex-direction: column;
                align-items: center;
                padding-bottom: 10px; /* Reduced padding */
            }
            .app-header h1 {
                text-align: center;
                margin-bottom: 10px;
                font-size: 1.5rem; /* Adjusted font size */
            }
             .header-buttons {
                 flex-direction: column;
                 width: 100%;
                 gap: 8px; /* Adjusted gap */
             }
             .header-buttons button {
                 width: 100%;
             }
             .export-buttons button {
                display: block;
                width: 100%;
                margin: 10px 0;
            }
             .attendance-table th, .attendance-table td,
             .analysis-table th, .analysis-table td,
             .student-history-table th, .student-history-table td {
                 padding: 8px; /* Reduced table padding */
                 font-size: 0.9rem; /* Slightly smaller font */
             }
             .status-select {
                 padding: 4px; /* Reduced padding */
                 font-size: 0.9rem;
             }
             .notes-section textarea {
                 min-height: 100px; /* Adjusted height */
             }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

    <div class="login-container" id="login-container">
        <h2>เข้าสู่ระบบ</h2>
        <div class="login-form">
            <input type="email" id="login-email" placeholder="อีเมล">
            <input type="password" id="login-password" placeholder="รหัสผ่าน">
            <button onclick="login()">เข้าสู่ระบบ</button>
            <div class="login-error" id="login-error"></div>
        </div>
    </div>

    <div id="main-app-content" style="display: none;">
        <div class="container" id="daily-report-container">
            <div class="app-header">
                 <h1>ระบบบันทึกเวลาเรียน</h1>
                 <div class="header-buttons">
                     <button class="view-button" onclick="showDailyReport()">ดูรายงานรายวัน</button>
                     <button class="view-button" onclick="showComparativeAnalysis()">ดูรายงานสรุป</button>
                     <button class="logout-button" onclick="logout()">ออกจากระบบ</button>
                 </div>
            </div>
            <h2>ชั้นประถมศึกษาปีที่ 5</h2>

            <div class="controls">
                <div>
                    <label for="attendance-date">วันที่:</label>
                    <input type="date" id="attendance-date">
                </div>
                <div>
                    <label for="semester">ภาคเรียน:</label>
                    <select id="semester">
                        <option value="1">ภาคเรียนที่ 1</option>
                        <option value="2">ภาคเรียนที่ 2</option>
                    </select>
                </div>
                <div>
                    <label for="academic-year">ปีการศึกษา:</label>
                    <select id="academic-year">
                        </select>
                </div>
                 <div>
                     <label for="attendance-grade-filter">เลือกระดับชั้น:</label>
                     <select id="attendance-grade-filter" onchange="populateAttendanceTable()">
                         <option value="">ทุกระดับชั้น</option>
                         <option value="P.4">ป.4</option>
                         <option value="P.5">ป.5</option>
                         <option value="P.6">ป.6</option>
                     </select>
                 </div>
            </div>

            <table class="attendance-table" id="attendance-table">
                <thead>
                    <tr>
                        <th>เลขประจำตัว</th>
                        <th>เลขที่</th>
                        <th>ชื่อ-นามสกุล</th>
                        <th>สถานะ</th>
                    </tr>
                </thead>
                <tbody id="student-attendance-body">
                    </tbody>
            </table>

            <div class="statistics">
                เปอร์เซ็นต์นักเรียนที่มาเรียนวันนี้: <span id="present-percentage">0%</span>
            </div>

            <div class="notes-section">
                <h3>บันทึกเพิ่มเติม</h3>
                <textarea id="teacher-notes" placeholder="บันทึกข้อสังเกตพฤติกรรมนักเรียน..."></textarea>
            </div>

            <button class="save-button" onclick="saveAttendance()">บันทึกข้อมูล</button>

            <div class="confirmation-message" id="save-confirmation">
                บันทึกข้อมูลเรียบร้อย!
            </div>
             <div class="error-message" id="error-message">
                เกิดข้อผิดพลาดในการบันทึกข้อมูล.
            </div>

            <div class="export-buttons">
                <button onclick="exportToPdf()">ส่งออกเป็น PDF</button>
                <button onclick="exportToCsv()">ส่งออกเป็น CSV (สำหรับ Excel)</button>
            </div>

        </div>

        <div class="container comparative-analysis-container" id="comparative-analysis-container">
             <div class="app-header">
                 <h1>ระบบบันทึกเวลาเรียน</h1>
                 <div class="header-buttons">
                     <button class="view-button" onclick="showDailyReport()">ดูรายงานรายวัน</button>
                     <button class="view-button" onclick="showComparativeAnalysis()">ดูรายงานสรุป</button>
                     <button class="logout-button" onclick="logout()">ออกจากระบบ</button>
                 </div>
            </div>
            <div id="comparative-summary-view">
                <h2>รายงานสรุปเวลาเรียน</h2>
                 <p>แสดงข้อมูลสรุปการเข้าเรียนของนักเรียนแต่ละคน ตลอดภาคเรียน/ปีการศึกษาที่เลือก</p>

                 <div class="controls">
                     <div>
                         <label for="analysis-semester">ภาคเรียน:</label>
                         <select id="analysis-semester">
                             <option value="1">ภาคเรียนที่ 1</option>
                             <option value="2">ภาคเรียนที่ 2</option>
                         </select>
                     </div>
                     <div>
                         <label for="analysis-academic-year">ปีการศึกษา:</label>
                         <select id="analysis-academic-year">
                             </select>
                     </div>
                      <div>
                         <label for="analysis-grade-filter">เลือกระดับชั้น:</label>
                         <select id="analysis-grade-filter">
                             <option value="">ทุกระดับชั้น</option>
                             <option value="P.4">ป.4</option>
                             <option value="P.5">ป.5</option>
                             <option value="P.6">ป.6</option>
                         </select>
                     </div>
                     <button onclick="generateComparativeReport()">สร้างรายงาน</button>
                 </div>


                <table class="analysis-table">
                    <thead>
                        <tr>
                            <th>เลขประจำตัว</th>
                            <th>เลขที่</th>
                            <th>ชื่อ-นามสกุล</th>
                            <th>มาเรียน</th>
                            <th>ป่วย</th>
                            <th>ลา</th>
                            <th>ขาด</th>
                            <th>รวมวัน</th>
                        </tr>
                    </thead>
                    <tbody id="comparative-analysis-body">
                        </tbody>
                </table>
            </div>

             <div class="student-history-detail" id="student-history-detail">
                 <button class="back-button" onclick="hideStudentHistory()">ย้อนกลับ</button>
                 <h3 id="student-history-title">ประวัติการเข้าเรียนของนักเรียน: </h3>

                 <table class="student-history-table">
                     <thead>
                         <tr>
                             <th>วันที่</th>
                             <th>สถานะ</th>
                             <th>ภาคเรียน</th>
                             <th>ปีการศึกษา</th>
                         </tr>
                     </thead>
                     <tbody id="student-history-body">
                         </tbody>
                 </table>
             </div>


        </div>


        <div class="student-management-container">
            <h2>จัดการข้อมูลนักเรียน</h2>

            <div class="student-form">
                <input type="text" id="student-id" placeholder="เลขประจำตัว">
                <input type="number" id="student-number" placeholder="เลขที่">
                <input type="text" id="student-name" placeholder="ชื่อ-นามสกุล">
                 <select id="student-grade">
                     <option value="">เลือกระดับชั้น</option>
                     <option value="P.4">ป.4</option>
                     <option value="P.5">ป.5</option>
                     <option value="P.6">ป.6</option>
                 </select>
                <div>
                    <label for="student-photo">รูปโปรไฟล์:</label>
                    <input type="file" id="student-photo" accept="image/*">
                </div>
                <button onclick="addOrUpdateStudent()">เพิ่ม/แก้ไข นักเรียน</button>
            </div>

            <ul class="student-list" id="student-list">
                </ul>
        </div>
    </div>


    <script type="text/javascript">
        // --- Firebase Configuration ---
        // Replace with your actual Firebase project configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBrGSCIQjT1V-dmR3LQaB-hkrSi_yWcg_I",
  authDomain: "attendance-system-c5235.firebaseapp.com",
    databaseURL: "https://attendance-system-c5235-default-rtdb.asia-southeast1.firebasedatabase.app", 
  projectId: "attendance-system-c5235",
  storageBucket: "attendance-system-c5235.firebasestorage.app",
  messagingSenderId: "687349069254",
  appId: "1:687349069254:web:1bf765f9f0bafb86f1eec7",
  measurementId: "G-TZJ0F2EXTE"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth(); // Get Firebase Auth instance
        const storage = firebase.storage(); // Get Firebase Storage instance
        const studentsRef = database.ref('students'); // Reference to the 'students' node
        const attendanceRef = database.ref('attendance'); // Reference to the 'attendance' node
        // --- End Firebase Configuration ---

        let students = []; // Array to hold ALL student data loaded from Firebase

        // Get references to the main content and login containers
        const mainAppContent = document.getElementById('main-app-content');
        const loginContainer = document.getElementById('login-container');
        const loginError = document.getElementById('login-error');
        const dailyReportContainer = document.getElementById('daily-report-container');
        const comparativeAnalysisContainer = document.getElementById('comparative-analysis-container');

        // Get references to the grade filter selects
        const attendanceGradeFilterSelect = document.getElementById('attendance-grade-filter');
        const analysisGradeFilterSelect = document.getElementById('analysis-grade-filter');

        // Get references for comparative analysis views
        const comparativeSummaryView = document.getElementById('comparative-summary-view');
        const studentHistoryDetail = document.getElementById('student-history-detail');
        const studentHistoryTitle = document.getElementById('student-history-title');
        const studentHistoryBody = document.getElementById('student-history-body');


        // Variable to store the unsubscribe function for the student listener
        let studentsListener = null;


        // --- Authentication Functions ---

        // Function to handle user login
        function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            loginError.textContent = ''; // Clear previous errors

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Signed in
                    const user = userCredential.user;
                    console.log("User logged in:", user.email);
                    // The onAuthStateChanged listener will handle showing the main content
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    console.error("Login error:", errorCode, errorMessage);
                    // Display error message to the user
                    loginError.textContent = `เข้าสู่ระบบไม่สำเร็จ: ${errorMessage}`;
                    loginError.style.display = 'block';
                });
        }

        // Function to handle user logout
        function logout() {
            auth.signOut().then(() => {
                // Sign-out successful.
                console.log("User logged out");
                // The onAuthStateChanged listener will handle showing the login page
            }).catch((error) => {
                // An error happened.
                 console.error("Logout error:", error);
                 // Optionally display an error message for logout
            });
        }

        // Listen for authentication state changes
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in.
                console.log("Auth state changed: User is signed in.");
                loginContainer.style.display = 'none'; // Hide login form
                mainAppContent.style.display = 'block'; // Show main content
                 loginError.style.display = 'none'; // Hide any login errors

                // Load necessary data after login
                populateAcademicYears();
                // Set default date to today and load attendance
                const today = new Date().toISOString().split('T')[0];
                const attendanceDateInput = document.getElementById('attendance-date');
                attendanceDateInput.value = today;

                // Start the real-time listener for students
                startStudentListener();

                 // Add event listener to date input to load data when date changes
                attendanceDateInput.addEventListener('change', (event) => {
                    loadAttendance(event.target.value);
                });

                // Show the daily report by default after login
                showDailyReport();


            } else {
                // User is signed out.
                console.log("Auth state changed: User is signed out.");
                mainAppContent.style.display = 'none'; // Hide main content
                loginContainer.style.display = 'block'; // Show login form

                 // Stop the real-time listener for students when logged out
                 stopStudentListener();

                 // Clear any sensitive data or state if needed
                 students = [];
                 document.getElementById('student-attendance-body').innerHTML = '';
                 document.getElementById('student-list').innerHTML = '';
                 document.getElementById('teacher-notes').value = '';
                 document.getElementById('present-percentage').textContent = '0%';
                 document.getElementById('academic-year').innerHTML = ''; // Clear academic years
                 document.getElementById('semester').value = '1'; // Reset semester
                 document.getElementById('analysis-academic-year').innerHTML = ''; // Clear analysis academic years
                 document.getElementById('analysis-semester').value = '1'; // Reset analysis semester
                 document.getElementById('comparative-analysis-body').innerHTML = ''; // Clear analysis table body
                 attendanceGradeFilterSelect.value = ''; // Reset grade filters
                 analysisGradeFilterSelect.value = '';
                 studentHistoryBody.innerHTML = ''; // Clear student history
                 studentHistoryDetail.style.display = 'none'; // Hide history view
                 comparativeSummaryView.style.display = 'block'; // Show summary view
            }
        });


        // --- View Toggling Functions ---
        function showDailyReport() {
            dailyReportContainer.style.display = 'block';
            comparativeAnalysisContainer.style.display = 'none';
             // Reload attendance for the current date when switching back to daily view
             const currentDate = document.getElementById('attendance-date').value;
             if (currentDate) {
                 loadAttendance(currentDate);
             } else {
                 // If no date is set, just populate the table with students (filtered by grade)
                 populateAttendanceTable();
                 calculatePresentPercentage();
             }
        }

        function showComparativeAnalysis() {
            dailyReportContainer.style.display = 'none';
            comparativeAnalysisContainer.style.display = 'block';
             // Ensure the summary view is shown and detail view is hidden
             comparativeSummaryView.style.display = 'block';
             studentHistoryDetail.style.display = 'none';

             // Populate academic years for the analysis controls if not already done
             populateAcademicYearsForAnalysis();
             // Clear the analysis table initially
             document.getElementById('comparative-analysis-body').innerHTML = '';
        }

        function hideStudentHistory() {
            studentHistoryDetail.style.display = 'none';
            comparativeSummaryView.style.display = 'block';
             // Re-generate the comparative report when going back
             generateComparativeReport();
        }


         // Function to populate academic years for the analysis controls
        function populateAcademicYearsForAnalysis() {
            const yearSelect = document.getElementById('analysis-academic-year');
             if (yearSelect.options.length > 0) return; // Avoid repopulating

            const currentYear = new Date().getFullYear();
            const startYear = (new Date().getMonth() >= 4) ? currentYear : currentYear - 1;
            for (let i = 0; i < 5; i++) {
                const year = startYear - i;
                const option = document.createElement('option');
                option.value = year;
                option.textContent = `ปีการศึกษา ${year + 543}`;
                yearSelect.appendChild(option);
            }
        }


        // --- Attendance and Student Management Functions ---

        // Function to populate academic years (for daily report controls)
        function populateAcademicYears() {
            const yearSelect = document.getElementById('academic-year');
            yearSelect.innerHTML = ''; // Clear existing options
            const currentYear = new Date().getFullYear();
            // Assuming academic year starts around May
            const startYear = (new Date().getMonth() >= 4) ? currentYear : currentYear - 1;
            for (let i = 0; i < 5; i++) { // Populate 5 years back
                const year = startYear - i;
                const option = document.createElement('option');
                option.value = year;
                option.textContent = `ปีการศึกษา ${year + 543}`; // Buddhist Era
                yearSelect.appendChild(option);
            }
        }

        // Function to populate the attendance table using the loaded students array (with optional grade filter)
        function populateAttendanceTable() {
            const tbody = document.getElementById('student-attendance-body');
            tbody.innerHTML = ''; // Clear existing rows

            const selectedGrade = attendanceGradeFilterSelect.value;
            const filteredStudents = selectedGrade
                ? students.filter(student => student.grade === selectedGrade)
                : students; // Show all students if no grade is selected


            if (filteredStudents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ไม่พบข้อมูลนักเรียนสำหรับระดับชั้นที่เลือก</td></tr>';
                return;
            }

            filteredStudents.forEach(student => {
                const row = document.createElement('tr');
                row.setAttribute('data-student-id', student.id); // Add data attribute for ID

                row.innerHTML = `
                    <td>${student.id}</td>
                    <td>${student.number}</td>
                    <td>${student.name}</td>
                    <td>
                        <select class="status-select" onchange="updateRowColor(this)">
                            <option value="present">มาเรียน</option>
                            <option value="sick">ป่วย</option>
                            <option value="leave">ลา</option>
                            <option value="absent">ขาด</option>
                        </select>
                    </td>
                `;
                tbody.appendChild(row);
            });
            calculatePresentPercentage(); // Recalculate percentage after populating
        }

        // Function to update row color based on status selection
        function updateRowColor(selectElement) {
            const row = selectElement.closest('tr');
            const status = selectElement.value;

            // Remove existing status classes
            row.classList.remove('status-present', 'status-sick', 'status-leave', 'status-absent');

            // Add the class corresponding to the selected status
            if (status === 'present') {
                row.classList.add('status-present');
            } else if (status === 'sick') {
                row.classList.add('status-sick');
            } else if (status === 'leave') {
                row.classList.add('status-leave');
            } else if (status === 'absent') {
                row.classList.add('status-absent');
            }

            calculatePresentPercentage(); // Recalculate percentage after status change
        }

        // Function to calculate and display the percentage of students present
        function calculatePresentPercentage() {
            const rows = document.querySelectorAll('#student-attendance-body tr');
            let presentCount = 0;
            rows.forEach(row => {
                const statusSelect = row.querySelector('.status-select');
                if (statusSelect && statusSelect.value === 'present') {
                    presentCount++;
                }
            });

             // Calculate percentage based on the currently displayed students
            const currentlyDisplayedStudents = document.querySelectorAll('#student-attendance-body tr').length;
            const percentage = currentlyDisplayedStudents > 0 ? (presentCount / currentlyDisplayedStudents) * 100 : 0;

            document.getElementById('present-percentage').textContent = `${percentage.toFixed(0)}%`;
        }

        // Function to save attendance data to Firebase
        function saveAttendance() {
            // Check if user is logged in before saving
            if (!auth.currentUser) {
                alert("กรุณาเข้าสู่ระบบก่อนบันทึกข้อมูล"); // Please log in before saving
                return;
            }

            const attendanceDate = document.getElementById('attendance-date').value;
             if (!attendanceDate) {
                alert("กรุณาเลือกวันที่บันทึกข้อมูล"); // Please select a date
                return;
            }
             if (students.length === 0) {
                 alert("ไม่พบข้อมูลนักเรียน กรุณาเพิ่มข้อมูลนักเรียนก่อนบันทึกเวลาเรียน"); // No student data found, please add student data before saving attendance
                 return;
             }
            const semester = document.getElementById('semester').value;
            const academicYear = document.getElementById('academic-year').value;
            const teacherNotes = document.getElementById('teacher-notes').value;
            const timestamp = new Date().toISOString(); // ISO 8601 format

            const attendanceRecords = [];
            const rows = document.querySelectorAll('#student-attendance-body tr');
            rows.forEach(row => {
                const studentId = row.getAttribute('data-student-id');
                const statusSelect = row.querySelector('.status-select');
                if (statusSelect) {
                    attendanceRecords.push({
                        studentId: studentId,
                        status: statusSelect.value
                    });
                }
            });

            const attendanceData = {
                date: attendanceDate,
                semester: semester,
                academicYear: academicYear,
                timestamp: timestamp,
                notes: teacherNotes,
                records: attendanceRecords,
                recordedBy: auth.currentUser.email // Store who recorded the attendance
            };

            // Use the date as the key for storing attendance data
            const dateKey = attendanceDate.replace(/-/g, ''); // Remove hyphens for a valid key

            // Save data to Firebase Realtime Database
            database.ref('attendance/' + dateKey).set(attendanceData)
                .then(() => {
                    console.log("Attendance data saved successfully!");
                    // Show confirmation message
                    const confirmationMessage = document.getElementById('save-confirmation');
                    confirmationMessage.style.display = 'block';
                     const errorMessage = document.getElementById('error-message');
                    errorMessage.style.display = 'none';


                    // Hide confirmation message after a few seconds
                    setTimeout(() => {
                        confirmationMessage.style.display = 'none';
                    }, 3000); // Hide after 3 seconds
                })
                .catch((error) => {
                    console.error("Error saving attendance data:", error);
                     // Show error message
                    const errorMessage = document.getElementById('error-message');
                    errorMessage.textContent = `เกิดข้อผิดพลาดในการบันทึกข้อมูล: ${error.message}`;
                    errorMessage.style.display = 'block';
                     const confirmationMessage = document.getElementById('save-confirmation');
                    confirmationMessage.style.display = 'none';
                });
        }

        // Function to load attendance data from Firebase for a specific date
        function loadAttendance(date) {
             // Check if user is logged in before loading
            if (!auth.currentUser) {
                console.log("User not logged in, cannot load attendance.");
                return;
            }

            const dateKey = date.replace(/-/g, '');
            const teacherNotesTextarea = document.getElementById('teacher-notes');
            const tbody = document.getElementById('student-attendance-body');

            // Clear previous data display and reset table (filtered by current grade selection)
            populateAttendanceTable(); // This will populate with students filtered by the attendance-grade-filter
            teacherNotesTextarea.value = ''; // Clear notes

            database.ref('attendance/' + dateKey).once('value')
                .then((snapshot) => {
                    const attendanceData = snapshot.val();
                    if (attendanceData) {
                        console.log("Loaded attendance data:", attendanceData);

                        // Populate the table with loaded data
                        if (attendanceData.records) {
                            attendanceData.records.forEach(record => {
                                // Only update rows for students currently displayed (based on grade filter)
                                const row = tbody.querySelector(`tr[data-student-id='${record.studentId}']`);
                                if (row) {
                                    const statusSelect = row.querySelector('.status-select');
                                    if (statusSelect) {
                                        statusSelect.value = record.status;
                                        updateRowColor(statusSelect); // Update color based on loaded status
                                    }
                                }
                            });
                        }

                        // Populate the notes section
                        if (attendanceData.notes) {
                            teacherNotesTextarea.value = attendanceData.notes;
                        }

                        calculatePresentPercentage(); // Calculate percentage based on loaded data

                    } else {
                        console.log("No attendance data found for this date. Displaying default.");
                        // Table is already reset by populateAttendanceTable()
                        calculatePresentPercentage(); // Calculate percentage for default state
                    }
                })
                .catch((error) => {
                    console.error("Error loading attendance data:", error);
                     const errorMessage = document.getElementById('error-message');
                    errorMessage.textContent = `เกิดข้อผิดพลาดในการโหลดข้อมูล: ${error.message}`;
                    errorMessage.style.display = 'block';
                });
        }

        // --- Student CRUD Functions ---

        // Function to render the list of students in the management section
        function renderStudentList() {
            const studentListUl = document.getElementById('student-list');
            studentListUl.innerHTML = ''; // Clear existing list

            if (students.length === 0) {
                 const listItem = document.createElement('li');
                 listItem.textContent = "ไม่พบข้อมูลนักเรียน";
                 studentListUl.appendChild(listItem);
                 return;
            }

            students.forEach(student => {
                const listItem = document.createElement('li');
                listItem.classList.add('student-item');
                listItem.setAttribute('data-student-id', student.id); // Use student ID as data attribute

                listItem.innerHTML = `
                    ${student.photo ? `<img src="${student.photo}" alt="รูปโปรไฟล์" class="student-photo-preview">` : ''}
                    <span>
                        ${student.number}. ${student.name} (ID: ${student.id})
                        ${student.grade ? ` - ชั้น ${student.grade}` : ''}
                    </span>
                    <div>
                        <button class="edit-button" onclick="editStudent('${student.id}')">แก้ไข</button>
                        <button class="delete-button" onclick="deleteStudent('${student.id}')">ลบ</button>
                    </div>
                `;
                studentListUl.appendChild(listItem);
            });
        }

        // Function to add or update a student in Firebase
        async function addOrUpdateStudent() { // Made function async to use await
             // Check if user is logged in before saving
            if (!auth.currentUser) {
                alert("กรุณาเข้าสู่ระบบก่อนจัดการข้อมูลนักเรียน"); // Please log in before managing student data
                return;
            }

            const studentIdInput = document.getElementById('student-id');
            const studentNumberInput = document.getElementById('student-number');
            const studentNameInput = document.getElementById('student-name');
            const studentGradeSelect = document.getElementById('student-grade');
            const studentPhotoInput = document.getElementById('student-photo');


            const studentId = studentIdInput.value.trim();
            const studentNumber = parseInt(studentNumberInput.value.trim(), 10);
            const studentName = studentNameInput.value.trim();
            const studentGrade = studentGradeSelect.value;
            const photoFile = studentPhotoInput.files[0]; // Get the selected file


            if (!studentId || !studentName || isNaN(studentNumber) || !studentGrade) {
                alert("กรุณากรอกข้อมูลนักเรียนให้ครบถ้วน (เลขประจำตัว, เลขที่, ชื่อ-นามสกุล, ระดับชั้น)");
                return;
            }

            let photoURL = '';

            // If a photo file is selected, upload it
            if (photoFile) {
                try {
                    const storageRef = storage.ref(`student_photos/${studentId}/${photoFile.name}`);
                    const snapshot = await storageRef.put(photoFile); // Upload the file
                    photoURL = await snapshot.ref.getDownloadURL(); // Get the download URL
                    console.log("Photo uploaded successfully:", photoURL);
                } catch (error) {
                    console.error("Error uploading photo:", error);
                     const errorMessage = document.getElementById('error-message');
                    errorMessage.textContent = `เกิดข้อผิดพลาดในการอัปโหลดรูปโปรไฟล์: ${error.message}`;
                    errorMessage.style.display = 'block';
                    return; // Stop if photo upload fails
                }
            } else {
                 // If no new photo is selected, check if the student already has a photo URL
                 const existingStudent = students.find(s => s.id === studentId);
                 if (existingStudent && existingStudent.photo) {
                     photoURL = existingStudent.photo; // Keep the existing photo URL
                 }
            }


            const studentData = {
                id: studentId,
                number: studentNumber,
                name: studentName,
                grade: studentGrade, // Added grade
                photo: photoURL // Store the photo URL
            };

            // Use student ID as the key in Firebase
            studentsRef.child(studentId).set(studentData)
                .then(() => {
                    console.log("Student data saved successfully:", studentData);
                    // Clear the form
                    studentIdInput.value = '';
                    studentNumberInput.value = '';
                    studentNameInput.value = '';
                    studentGradeSelect.value = ''; // Clear grade selection
                    studentPhotoInput.value = ''; // Clear the file input
                    // No need to call loadStudents() here, the listener will handle the update
                })
                .catch((error) => {
                    console.error("Error saving student data:", error);
                     const errorMessage = document.getElementById('error-message');
                    errorMessage.textContent = `เกิดข้อผิดพลาดในการบันทึกข้อมูลนักเรียน: ${error.message}`;
                    errorMessage.style.display = 'block';
                });
        }

        // Function to start the real-time listener for students
        function startStudentListener() {
             // Check if user is logged in before starting listener
            if (!auth.currentUser) {
                 console.log("User not logged in, cannot start student listener.");
                return;
            }

            // Remove any existing listener to avoid duplicates
            stopStudentListener();

            studentsListener = studentsRef.on('value', (snapshot) => {
                const studentsData = snapshot.val();
                students = []; // Clear the current students array
                if (studentsData) {
                    // Convert the object of students to an array
                    for (const studentId in studentsData) {
                        students.push(studentsData[studentId]);
                    }
                     // Sort students by number
                    students.sort((a, b) => a.number - b.number);
                    console.log("Students data updated:", students);
                } else {
                     console.log("No students found in database.");
                }
                // Render the student list and populate the attendance table whenever data changes
                renderStudentList();
                // Populate attendance table based on the current grade filter
                populateAttendanceTable();


                // After students are updated, reload attendance for the current date IF daily report is visible
                 if (dailyReportContainer.style.display !== 'none') {
                     const currentDate = document.getElementById('attendance-date').value;
                     if (currentDate) {
                         loadAttendance(currentDate);
                     } else {
                         // If no date is set, calculate percentage for the default empty state
                         calculatePresentPercentage();
                     }
                 }

                 // If the comparative analysis is visible and not showing history, regenerate the summary
                 if (comparativeAnalysisContainer.style.display !== 'none' && studentHistoryDetail.style.display === 'none') {
                      generateComparativeReport();
                 }


            }, (error) => {
                console.error("Error in student listener:", error);
                 const errorMessage = document.getElementById('error-message');
                errorMessage.textContent = `เกิดข้อผิดพลาดในการอัปเดตข้อมูลนักเรียนแบบเรียลไทม์: ${error.message}`;
                errorMessage.style.display = 'block';
            });
             console.log("Student listener started.");
        }

        // Function to stop the real-time listener for students
        function stopStudentListener() {
            if (studentsListener) {
                studentsRef.off('value', studentsListener);
                studentsListener = null;
                console.log("Student listener stopped.");
            }
        }


        // Function to populate the form for editing a student
        function editStudent(studentId) {
             // Check if user is logged in before editing
            if (!auth.currentUser) {
                alert("กรุณาเข้าสู่ระบบก่อนแก้ไขข้อมูลนักเรียน"); // Please log in before editing student data
                return;
            }
            const student = students.find(s => s.id === studentId);
            if (student) {
                document.getElementById('student-id').value = student.id;
                document.getElementById('student-number').value = student.number;
                document.getElementById('student-name').value = student.name;
                document.getElementById('student-grade').value = student.grade || '';

                // Note: File inputs are read-only for security.
                // We cannot programmatically set the selected file.
                // The user will need to re-select the photo if they want to change it.
                // We could display the current photo URL or a preview here if needed.
                console.log("Editing student. Existing photo URL:", student.photo);
            }
        }

        // Function to delete a student from Firebase
        async function deleteStudent(studentId) { // Made function async to use await
             // Check if user is logged in before deleting
            if (!auth.currentUser) {
                alert("กรุณาเข้าสู่ระบบก่อนลบข้อมูลนักเรียน"); // Please log in before deleting student data
                return;
            }
            if (confirm(`คุณต้องการลบนักเรียน เลขประจำตัว ${studentId} ใช่หรือไม่?`)) {

                try {
                     // Optional: Delete the photo from Storage first
                     const studentToDelete = students.find(s => s.id === studentId);
                     if (studentToDelete && studentToDelete.photo) {
                         const photoUrl = studentToDelete.photo;
                         // Get the storage reference from the download URL
                         const photoRef = storage.refFromURL(photoUrl);
                         await photoRef.delete();
                         console.log("Student photo deleted from Storage:", studentId);
                     }

                    await studentsRef.child(studentId).remove(); // Delete data from Realtime Database
                    console.log("Student data deleted successfully:", studentId);
                    // No need to call loadStudents() here, the listener will handle the update
                } catch (error) {
                    console.error("Error deleting student data or photo:", error);
                     const errorMessage = document.getElementById('error-message');
                    errorMessage.textContent = `เกิดข้อผิดพลาดในการลบข้อมูลนักเรียน: ${error.message}`;
                    errorMessage.style.display = 'block';
                }
            }
        }

        // --- Export Functions ---

        // Function to export attendance data to PDF
        function exportToPdf() {
             // Check if user is logged in before exporting
            if (!auth.currentUser) {
                alert("กรุณาเข้าสู่ระบบก่อนส่งออกข้อมูล"); // Please log in before exporting
                return;
            }

            // Determine which report is currently visible to export
            if (dailyReportContainer.style.display !== 'none') {
                exportDailyReportPdf();
            } else if (comparativeAnalysisContainer.style.display !== 'none' && studentHistoryDetail.style.display === 'none') {
                exportComparativeReportPdf();
            } else if (studentHistoryDetail.style.display !== 'none') {
                 exportStudentHistoryPdf();
            }
            else {
                alert("กรุณาเลือกรายงานที่ต้องการส่งออก"); // Please select a report to export
            }
        }

         // Function to export the Daily Report to PDF
         function exportDailyReportPdf() {
             const attendanceDate = document.getElementById('attendance-date').value;
             if (!attendanceDate) {
                 alert("กรุณาเลือกวันที่ต้องการส่งออกข้อมูลรายงานรายวัน");
                 return;
             }

             const { jsPDF } = window.jspdf;
             const doc = new jsPDF();

             // doc.setFont('Sarabun', 'normal'); // Set Thai font - requires font embedding for full support

             // Get table data
             const table = document.getElementById('attendance-table');
             const header = [];
             const rows = [];

             // Get header
             table.querySelectorAll('thead th').forEach(th => {
                 header.push(th.textContent.trim());
             });

             // Get row data
             table.querySelectorAll('tbody tr').forEach(tr => {
                 const rowData = [];
                 tr.querySelectorAll('td').forEach((td, index) => {
                     if (index === 3) { // Status column
                          const selectElement = td.querySelector('.status-select');
                          rowData.push(selectElement ? selectElement.options[selectElement.selectedIndex].text : td.textContent.trim());
                     } else {
                          rowData.push(td.textContent.trim());
                     }
                 });
                 rows.push(rowData);
             });

             // Add title and date
             doc.setFontSize(18);
             doc.text(`รายงานบันทึกเวลาเรียน ชั้นประถมศึกษาปีที่ 5`, 14, 22);
             doc.setFontSize(12);
             doc.text(`วันที่: ${attendanceDate}`, 14, 30);

             // Add table
             doc.autoTable({
                 startY: 40,
                 head: [header],
                 body: rows,
                 theme: 'striped',
                 headStyles: { fillColor: [76, 175, 80] }, // Green header
                 styles: { font: 'Sarabun', fontStyle: 'normal' }, // Apply font to table (might need embedding)
                 didDrawPage: function (data) {
                     // Footer
                     let pageNumber = doc.internal.getNumberOfPages();
                     doc.setFontSize(10);
                     doc.text('Page ' + pageNumber, data.settings.margin.left, doc.internal.pageSize.height - 10);
                 }
             });

              // Add Notes section if available
              const teacherNotes = document.getElementById('teacher-notes').value.trim();
              if (teacherNotes) {
                  let finalY = doc.lastAutoTable.finalY; // Get the end Y position of the table
                  doc.setFontSize(12);
                  doc.text('บันทึกเพิ่มเติม:', 14, finalY + 20);
                  doc.setFontSize(10);
                  // Split notes into lines to fit within page width
                  const splitNotes = doc.splitTextToSize(teacherNotes, doc.internal.pageSize.width - 28); // 28 = left + right margin
                  doc.text(splitNotes, 14, finalY + 28);
              }


             // Save the PDF
             doc.save(`รายงานบันทึกเวลาเรียน_รายวัน_${attendanceDate}.pdf`);
         }

         // Function to export the Comparative Report to PDF
         function exportComparativeReportPdf() {
              const analysisSemester = document.getElementById('analysis-semester').value;
              const analysisAcademicYear = document.getElementById('analysis-academic-year').value;
              const analysisGrade = analysisGradeFilterSelect.value; // Get selected grade for report title

              const { jsPDF } = window.jspdf;
              const doc = new jsPDF();

              // doc.setFont('Sarabun', 'normal'); // Set Thai font - requires font embedding for full support

              // Get table data from the analysis table
              const table = document.querySelector('#comparative-analysis-container .analysis-table');
              const header = [];
              const rows = [];

              // Get header
              table.querySelectorAll('thead th').forEach(th => {
                  header.push(th.textContent.trim());
              });

              // Get row data
              table.querySelectorAll('tbody tr').forEach(tr => {
                  const rowData = [];
                  tr.querySelectorAll('td').forEach(td => {
                      rowData.push(td.textContent.trim());
                  });
                  rows.push(rowData);
              });

              // Add title
              doc.setFontSize(18);
              doc.text(`รายงานสรุปเวลาเรียน ชั้นประถมศึกษาปีที่ 5`, 14, 22);
              doc.setFontSize(12);
              doc.text(`ภาคเรียนที่ ${analysisSemester} ปีการศึกษา ${parseInt(analysisAcademicYear) + 543}${analysisGrade ? ` (ชั้น ${analysisGrade})` : ' (ทุกระดับชั้น)'}`, 14, 30);


              // Add table
              doc.autoTable({
                  startY: 40,
                  head: [header],
                  body: rows,
                  theme: 'striped',
                  headStyles: { fillColor: [76, 175, 80] }, // Green header
                  styles: { font: 'Sarabun', fontStyle: 'normal' }, // Apply font to table (might need embedding)
                  didDrawPage: function (data) {
                      // Footer
                      let pageNumber = doc.internal.getNumberOfPages();
                      doc.setFontSize(10);
                      doc.text('Page ' + pageNumber, data.settings.margin.left, doc.internal.pageSize.height - 10);
                  }
              });

              // Save the PDF
              doc.save(`รายงานสรุปเวลาเรียน_ภาคเรียน${analysisSemester}_ปี${parseInt(analysisAcademicYear) + 543}${analysisGrade ? `_ชั้น${analysisGrade}` : ''}.pdf`);
         }

         // Function to export the Student History Detail to PDF
         function exportStudentHistoryPdf() {
             const studentId = studentHistoryDetail.getAttribute('data-student-id');
             const student = students.find(s => s.id === studentId);
             if (!student) {
                 alert("ไม่พบข้อมูลนักเรียนสำหรับส่งออกประวัติ");
                 return;
             }

             const { jsPDF } = window.jspdf;
             const doc = new jsPDF();

             // doc.setFont('Sarabun', 'normal'); // Set Thai font - requires font embedding for full support

             // Add title
             doc.setFontSize(18);
             doc.text(`ประวัติการเข้าเรียนของนักเรียน`, 14, 22);
             doc.setFontSize(14);
             doc.text(`ชื่อ: ${student.name} (ID: ${student.id})`, 14, 30);
             if (student.grade) {
                 doc.text(`ระดับชั้น: ${student.grade}`, 14, 38);
             }


             // Get table data from the student history table
             const table = document.querySelector('#student-history-detail .student-history-table');
              if (!table) {
                  alert("ไม่พบข้อมูลประวัติการเข้าเรียน");
                  return;
              }
             const header = [];
             const rows = [];

             // Get header
             table.querySelectorAll('thead th').forEach(th => {
                 header.push(th.textContent.trim());
             });

             // Get row data
             table.querySelectorAll('tbody tr').forEach(tr => {
                 const rowData = [];
                 tr.querySelectorAll('td').forEach(td => {
                     rowData.push(td.textContent.trim());
                 });
                 rows.push(rowData);
             });

             // Add table
             doc.autoTable({
                 startY: student.grade ? 46 : 40, // Adjust startY based on whether grade is shown
                 head: [header],
                 body: rows,
                 theme: 'striped',
                 headStyles: { fillColor: [76, 175, 80] }, // Green header
                 styles: { font: 'Sarabun', fontStyle: 'normal' }, // Apply font to table (might need embedding)
                 didDrawPage: function (data) {
                     // Footer
                     let pageNumber = doc.internal.getNumberOfPages();
                     doc.setFontSize(10);
                     doc.text('Page ' + pageNumber, data.settings.margin.left, doc.internal.pageSize.height - 10);
                 }
             });

             // Save the PDF
             doc.save(`ประวัติการเข้าเรียน_${student.id}.pdf`);
         }


        // Function to export attendance data to CSV (for Excel)
        function exportToCsv() {
             // Check if user is logged in before exporting
            if (!auth.currentUser) {
                alert("กรุณาเข้าสู่ระบบก่อนส่งออกข้อมูล"); // Please log in before exporting
                return;
            }

             // Determine which report is currently visible to export
            if (dailyReportContainer.style.display !== 'none') {
                exportDailyReportCsv();
            } else if (comparativeAnalysisContainer.style.display !== 'none' && studentHistoryDetail.style.display === 'none') {
                exportComparativeReportCsv();
            } else if (studentHistoryDetail.style.display !== 'none') {
                 exportStudentHistoryCsv();
            }
            else {
                alert("กรุณาเลือกรายงานที่ต้องการส่งออก"); // Please select a report to export
            }
        }

         // Function to export the Daily Report to CSV
         function exportDailyReportCsv() {
             const attendanceDate = document.getElementById('attendance-date').value;
              if (!attendanceDate) {
                 alert("กรุณาเลือกวันที่ต้องการส่งออกข้อมูลรายงานรายวัน");
                 return;
             }

             const table = document.getElementById('attendance-table');
             let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF"; // Add BOM for UTF-8 in Excel

             // Get header
             table.querySelectorAll('thead th').forEach(th => {
                 csvContent += `"${th.textContent.trim()}",`;
             });
             csvContent = csvContent.slice(0, -1) + "\n"; // Remove trailing comma and add newline

             // Get row data
             table.querySelectorAll('tbody tr').forEach(tr => {
                 tr.querySelectorAll('td').forEach((td, index) => {
                      if (index === 3) { // Status column
                          const selectElement = td.querySelector('.status-select');
                          csvContent += `"${selectElement ? selectElement.options[selectElement.selectedIndex].text : td.textContent.trim()}",`;
                     } else {
                          csvContent += `"${td.textContent.trim()}",`;
                     }
                 });
                 csvContent = csvContent.slice(0, -1) + "\n"; // Remove trailing comma and add newline
             });

              // Add Notes section if available
              const teacherNotes = document.getElementById('teacher-notes').value.trim();
              if (teacherNotes) {
                  csvContent += `\n"บันทึกเพิ่มเติม:",\n"${teacherNotes.replace(/"/g, '""')}"\n`; // Handle quotes in notes
              }


             const encodedUri = encodeURI(csvContent);
             const link = document.createElement("a");
             link.setAttribute("href", encodedUri);
             link.setAttribute("download", `รายงานบันทึกเวลาเรียน_รายวัน_${attendanceDate}.csv`);
             document.body.appendChild(link); // Required for Firefox
             link.click(); // Trigger the download
             document.body.removeChild(link); // Clean up
         }

         // Function to export the Comparative Report to CSV
         function exportComparativeReportCsv() {
              const analysisSemester = document.getElementById('analysis-semester').value;
              const analysisAcademicYear = document.getElementById('analysis-academic-year').value;
              const analysisGrade = analysisGradeFilterSelect.value; // Get selected grade for report title

              const table = document.querySelector('#comparative-analysis-container .analysis-table');
              let csvContent = "data:text/csv;charset=utf-8,%EF%BB% শিক্ষকদের"; // Add BOM for UTF-8 in Excel

              // Add title and period info
              csvContent += `"รายงานสรุปเวลาเรียน ชั้นประถมศึกษาปีที่ 5"\n`;
              csvContent += `"ภาคเรียนที่ ${analysisSemester} ปีการศึกษา ${parseInt(analysisAcademicYear) + 543}${analysisGrade ? ` (ชั้น ${analysisGrade})` : ' (ทุกระดับชั้น)'}"\n\n`;


              // Get header
              table.querySelectorAll('thead th').forEach(th => {
                  csvContent += `"${th.textContent.trim()}",`;
              });
              csvContent = csvContent.slice(0, -1) + "\n"; // Remove trailing comma and add newline

              // Get row data
              table.querySelectorAll('tbody tr').forEach(tr => {
                  const rowData = [];
                  tr.querySelectorAll('td').forEach(td => {
                      rowData.push(td.textContent.trim());
                  });
                  csvContent += `"${rowData.join('","')}"\n`; // Join row data with quotes and commas
              });


             const encodedUri = encodeURI(csvContent);
             const link = document.createElement("a");
             link.setAttribute("href", encodedUri);
             link.setAttribute("download", `รายงานสรุปเวลาเรียน_ภาคเรียน${analysisSemester}_ปี${parseInt(analysisAcademicYear) + 543}${analysisGrade ? `_ชั้น${analysisGrade}` : ''}.csv`);
             document.body.appendChild(link); // Required for Firefox
             link.click(); // Trigger the download
             document.body.removeChild(link); // Clean up
         }

         // Function to export the Student History Detail to CSV
         function exportStudentHistoryCsv() {
              const studentId = studentHistoryDetail.getAttribute('data-student-id');
             const student = students.find(s => s.id === studentId);
             if (!student) {
                 alert("ไม่พบข้อมูลนักเรียนสำหรับส่งออกประวัติ");
                 return;
             }

             const table = document.querySelector('#student-history-detail .student-history-table');
             if (!table) {
                 alert("ไม่พบข้อมูลประวัติการเข้าเรียน");
                 return;
             }

             let csvContent = "data:text/csv;charset=utf-8,%EF%BB% শিক্ষকদের"; // Add BOM for UTF-8 in Excel

             // Add title and student info
             csvContent += `"ประวัติการเข้าเรียนของนักเรียน"\n`;
             csvContent += `"ชื่อ: ${student.name} (ID: ${student.id})"\n`;
             if (student.grade) {
                 csvContent += `"ระดับชั้น: ${student.grade}"\n`;
             }
             csvContent += `\n`; // Add a blank line for separation


              // Get header
              table.querySelectorAll('thead th').forEach(th => {
                  csvContent += `"${th.textContent.trim()}",`;
              });
              csvContent = csvContent.slice(0, -1) + "\n"; // Remove trailing comma and add newline

              // Get row data
              table.querySelectorAll('tbody tr').forEach(tr => {
                  const rowData = [];
                  tr.querySelectorAll('td').forEach(td => {
                      rowData.push(td.textContent.trim());
                  });
                  csvContent += `"${rowData.join('","')}"\n`; // Join row data with quotes and commas
              });


             const encodedUri = encodeURI(csvContent);
             const link = document.createElement("a");
             link.setAttribute("href", encodedUri);
             link.setAttribute("download", `ประวัติการเข้าเรียน_${student.id}.csv`);
             document.body.appendChild(link); // Required for Firefox
             link.click(); // Trigger the download
             document.body.removeChild(link); // Clean up
         }


        // --- Comparative Analysis Functions ---

        // Function to generate the comparative attendance report
        function generateComparativeReport() {
             // Check if user is logged in before generating report
            if (!auth.currentUser) {
                alert("กรุณาเข้าสู่ระบบก่อนสร้างรายงาน"); // Please log in before generating report
                return;
            }

             if (students.length === 0) {
                 alert("ไม่พบข้อมูลนักเรียน ไม่สามารถสร้างรายงานสรุปได้"); // No student data found, cannot generate report
                 return;
             }


            const analysisSemester = document.getElementById('analysis-semester').value;
            const analysisAcademicYear = document.getElementById('analysis-academic-year').value;
            const analysisGrade = analysisGradeFilterSelect.value; // Get the selected grade for filtering
            const comparativeAnalysisBody = document.getElementById('comparative-analysis-body');
            comparativeAnalysisBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">กำลังโหลดข้อมูล...</td></tr>'; // Loading message


            // Fetch all attendance records
            attendanceRef.once('value')
                .then((snapshot) => {
                    const attendanceData = snapshot.val();
                    const studentAttendanceSummary = {};

                    // Initialize summary for each student, filtering by selected grade
                    students.forEach(student => {
                         if (!analysisGrade || student.grade === analysisGrade) {
                            studentAttendanceSummary[student.id] = {
                                present: 0,
                                sick: 0,
                                leave: 0,
                                absent: 0,
                                total: 0
                            };
                         }
                    });

                     const filteredStudents = students.filter(student => !analysisGrade || student.grade === analysisGrade);


                    if (attendanceData) {
                        // Process attendance data for the selected semester and academic year
                        for (const dateKey in attendanceData) {
                            const record = attendanceData[dateKey];
                            // Simple filtering by year and semester (assuming dateKey isYYYYMMDD)
                            const recordYear = parseInt(dateKey.substring(0, 4));
                            // You might need a more robust way to determine semester based on date
                            // For now, we'll rely on the saved semester value in the record
                            const recordSemester = record.semester;
                            const recordAcademicYear = record.academicYear;


                            if (recordAcademicYear == analysisAcademicYear && recordSemester == analysisSemester && record.records) {
                                record.records.forEach(studentRecord => {
                                    // Only include records for students in the selected grade (if filter is applied)
                                    const student = students.find(s => s.id === studentRecord.studentId);
                                     if (student && (!analysisGrade || student.grade === analysisGrade)) {
                                        if (studentAttendanceSummary[studentRecord.studentId]) {
                                            studentAttendanceSummary[studentRecord.studentId][studentRecord.status]++;
                                            studentAttendanceSummary[studentRecord.studentId].total++;
                                        }
                                     }
                                });
                            }
                        }
                    }

                    // Populate the comparative analysis table
                    comparativeAnalysisBody.innerHTML = ''; // Clear loading message

                    if (filteredStudents.length === 0) {
                         comparativeAnalysisBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">ไม่พบข้อมูลนักเรียนสำหรับระดับชั้นที่เลือก</td></tr>';
                         return;
                    }


                    filteredStudents.forEach(student => {
                        const summary = studentAttendanceSummary[student.id] || { present: 0, sick: 0, leave: 0, absent: 0, total: 0 };
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${student.id}</td>
                            <td>${student.number}</td>
                            <td>${student.name}</td>
                            <td>${summary.present}</td>
                            <td>${summary.sick}</td>
                            <td>${summary.leave}</td>
                            <td>${summary.absent}</td>
                            <td>${summary.total}</td>
                        `;
                         // Add click listener to the row to show history
                         row.style.cursor = 'pointer'; // Indicate clickable
                         row.onclick = () => showStudentHistory(student.id);

                        comparativeAnalysisBody.appendChild(row);
                    });

                     // Check if there are students displayed but no attendance data for the period
                     if (filteredStudents.length > 0 && Object.keys(studentAttendanceSummary).every(key => studentAttendanceSummary[key].total === 0)) {
                          comparativeAnalysisBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">ไม่พบข้อมูลการเข้าเรียนสำหรับภาคเรียนและปีการศึกษาที่เลือก</td></tr>';
                     }


                })
                .catch((error) => {
                    console.error("Error generating comparative report:", error);
                     const errorMessage = document.getElementById('error-message');
                    errorMessage.textContent = `เกิดข้อผิดพลาดในการสร้างรายงานสรุป: ${error.message}`;
                    errorMessage.style.display = 'block';
                     comparativeAnalysisBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>';
                });
        }

        // Function to show detailed attendance history for a specific student
        function showStudentHistory(studentId) {
             // Check if user is logged in before showing history
            if (!auth.currentUser) {
                alert("กรุณาเข้าสู่ระบบก่อนดูประวัติการเข้าเรียน"); // Please log in before viewing history
                return;
            }

            const student = students.find(s => s.id === studentId);
            if (!student) {
                console.error("Student not found for history view:", studentId);
                return;
            }

            // Hide the summary view and show the history detail view
            comparativeSummaryView.style.display = 'none';
            studentHistoryDetail.style.display = 'block';
             studentHistoryDetail.setAttribute('data-student-id', studentId); // Store student ID

            // Set the title
            studentHistoryTitle.textContent = `ประวัติการเข้าเรียนของนักเรียน: ${student.name} (ID: ${student.id})`;

            // Clear previous history data
            studentHistoryBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">กำลังโหลดข้อมูล...</td></tr>'; // Loading message


            // Fetch all attendance records to find the student's history
            attendanceRef.once('value')
                .then((snapshot) => {
                    const attendanceData = snapshot.val();
                    const studentHistoryRecords = [];

                    if (attendanceData) {
                        for (const dateKey in attendanceData) {
                            const record = attendanceData[dateKey];
                            if (record.records) {
                                const studentRecord = record.records.find(rec => rec.studentId === studentId);
                                if (studentRecord) {
                                    studentHistoryRecords.push({
                                        date: record.date,
                                        status: studentRecord.status,
                                        semester: record.semester,
                                        academicYear: record.academicYear
                                    });
                                }
                            }
                        }
                    }

                    // Sort history records by date (most recent first)
                    studentHistoryRecords.sort((a, b) => new Date(b.date) - new Date(a.date));

                    // Populate the student history table
                    studentHistoryBody.innerHTML = ''; // Clear loading message

                    if (studentHistoryRecords.length === 0) {
                        studentHistoryBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ไม่พบประวัติการเข้าเรียนสำหรับนักเรียนนี้</td></tr>';
                    } else {
                        studentHistoryRecords.forEach(history => {
                            const row = document.createElement('tr');
                             let statusText = history.status;
                             // Convert status value to Thai text for display
                             if (history.status === 'present') statusText = 'มาเรียน';
                             else if (history.status === 'sick') statusText = 'ป่วย';
                             else if (history.status === 'leave') statusText = 'ลา';
                             else if (history.status === 'absent') statusText = 'ขาด';


                            row.innerHTML = `
                                <td>${history.date}</td>
                                <td>${statusText}</td>
                                <td>${history.semester}</td>
                                <td>${parseInt(history.academicYear) + 543}</td>
                            `;
                            studentHistoryBody.appendChild(row);
                        });
                    }

                })
                .catch((error) => {
                     console.error("Error loading student history:", error);
                     const errorMessage = document.getElementById('error-message');
                    errorMessage.textContent = `เกิดข้อผิดพลาดในการโหลดประวัติการเข้าเรียน: ${error.message}`;
                    errorMessage.style.display = 'block';
                     studentHistoryBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>';
                });
        }


        // Initialize the page (This will now primarily set up the auth listener)
        window.onload = function() {
            // The onAuthStateChanged listener handles the initial display and data loading
            console.log("Window loaded. Waiting for authentication state.");
        };


    </script>

</body>
</html>
